<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>MedicNEET Quiz</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #fff;
            --bg2: #f7f7f7;
            --border: #e5e5e5;
            --green: #58cc02;
            --green-dk: #46a302;
            --green-lt: #d7ffb8;
            --red: #ff4b4b;
            --red-lt: #ffdada;
            --gold: #ffc800;
            --gold-dk: #ce9c09;
            --gold-lt: #fff4cc;
            --blue: #1cb0f6;
            --blue-dk: #1899d6;
            --blue-lt: #ddf4ff;
            --orange: #ff9600;
            --orange-lt: #fff0d4;
            --purple: #ce82ff;
            --txt: #3c3c3c;
            --txt2: #777;
            --txt3: #afafaf
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            color: var(--txt);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased
        }

        .header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--green)
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .logo-icon {
            font-size: 24px
        }

        .logo-text {
            font-weight: 900;
            font-size: 18px;
            color: #fff
        }

        .prize-badge {
            background: var(--gold);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 14px;
            color: var(--txt);
            box-shadow: 0 3px 0 var(--gold-dk);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .prize-badge:active {
            transform: translateY(3px);
            box-shadow: none
        }

        .timer-section {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg2);
            border-bottom: 2px solid var(--border)
        }

        .timer-label {
            font-size: 10px;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 800
        }

        .timer-value {
            font-size: 30px;
            font-weight: 900;
            font-variant-numeric: tabular-nums
        }

        .timer-value.danger {
            color: var(--red)
        }

        .stats-row {
            display: flex;
            gap: 8px
        }

        .stat-pill {
            padding: 6px 12px;
            border-radius: 12px;
            text-align: center
        }

        .stat-pill.blue {
            background: var(--blue-lt)
        }

        .stat-pill.orange {
            background: var(--orange-lt)
        }

        .stat-num {
            font-size: 15px;
            font-weight: 800
        }

        .stat-pill.blue .stat-num {
            color: var(--blue-dk)
        }

        .stat-pill.orange .stat-num {
            color: var(--orange)
        }

        .stat-lbl {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--txt3)
        }

        .screen {
            display: none;
            padding: 16px
        }

        .screen.active {
            display: block
        }

        .question-chapter {
            display: inline-block;
            background: var(--green-lt);
            color: var(--green-dk);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 14px
        }

        .question-text {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.65;
            margin-bottom: 20px
        }

        .question-block {
            background: var(--bg2);
            border: 2px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 3px 0 var(--border)
        }

        .question-number {
            display: inline-block;
            background: var(--green);
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 10px
        }

        .question-block.answered {
            border-color: var(--green);
            background: var(--green-lt)
        }

        .question-block.correct {
            border-color: var(--green);
            background: var(--green-lt);
            box-shadow: 0 3px 0 var(--green-dk)
        }

        .question-block.incorrect {
            border-color: var(--red);
            background: var(--red-lt);
            box-shadow: 0 3px 0 var(--red)
        }

        .stopwatch {
            text-align: center;
            margin-bottom: 16px
        }

        .stopwatch-value {
            font-size: 56px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            letter-spacing: -3px;
            line-height: 1
        }

        .stopwatch-label {
            font-size: 10px;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
            margin-top: 4px
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .option-btn {
            width: 100%;
            padding: 16px 18px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--txt);
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            text-align: left;
            box-shadow: 0 3px 0 var(--border);
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .option-btn:active {
            transform: translateY(3px);
            box-shadow: none
        }

        .opt-letter {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: var(--bg2);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0
        }

        .option-btn.correct {
            border-color: var(--green);
            background: var(--green-lt);
            box-shadow: 0 3px 0 var(--green-dk)
        }

        .option-btn.correct .opt-letter {
            background: var(--green);
            border-color: var(--green-dk);
            color: #fff
        }

        .option-btn.wrong {
            border-color: var(--red);
            background: var(--red-lt);
            box-shadow: 0 3px 0 var(--red)
        }

        .option-btn.wrong .opt-letter {
            background: var(--red);
            border-color: var(--red);
            color: #fff
        }

        .result-card {
            text-align: center;
            padding: 28px 20px;
            border-radius: 24px;
            border: 2px solid var(--border);
            margin-bottom: 16px;
            box-shadow: 0 4px 0 var(--border)
        }

        .result-card.win {
            background: var(--gold-lt);
            border-color: var(--gold);
            box-shadow: 0 4px 0 var(--gold-dk)
        }

        .result-card.correct {
            background: var(--green-lt);
            border-color: var(--green);
            box-shadow: 0 4px 0 var(--green-dk)
        }

        .result-card.wrong {
            background: var(--red-lt);
            border-color: var(--red);
            box-shadow: 0 4px 0 var(--red)
        }

        .result-icon {
            font-size: 56px;
            margin-bottom: 8px
        }

        .result-title {
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 4px
        }

        .result-title.win-text {
            color: var(--txt)
        }

        .result-title.correct-text {
            color: var(--green-dk)
        }

        .result-title.wrong-text {
            color: var(--red)
        }

        .result-sub {
            font-size: 14px;
            color: var(--txt2);
            font-weight: 600;
            margin-bottom: 16px
        }

        .result-time {
            font-size: 48px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            line-height: 1
        }

        .result-time-label {
            font-size: 12px;
            color: var(--txt3);
            font-weight: 700;
            margin-top: 4px
        }

        .share-challenge-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            font-family: inherit;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #388E3C;
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .share-challenge-btn:active {
            transform: translateY(4px);
            box-shadow: none
        }

        .explanation-card {
            background: var(--blue-lt);
            border: 2px solid var(--blue);
            border-radius: 18px;
            padding: 16px 18px;
            margin-bottom: 16px;
            box-shadow: 0 3px 0 var(--blue-dk)
        }

        .explanation-header {
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--blue-dk);
            margin-bottom: 8px
        }

        .explanation-text {
            font-size: 14px;
            line-height: 1.6;
            font-weight: 600
        }

        .winner-form {
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 0 var(--gold-dk)
        }

        .winner-form h3 {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 16px;
            text-align: center
        }

        .form-group {
            margin-bottom: 14px
        }

        .form-group label {
            display: block;
            font-size: 11px;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
            margin-bottom: 6px
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg2);
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 15px;
            font-family: inherit;
            font-weight: 600;
            outline: none
        }

        .form-input:focus {
            border-color: var(--gold)
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            cursor: pointer
        }

        .upload-area:hover {
            border-color: var(--gold)
        }

        .upload-area.has-file {
            border-color: var(--green);
            border-style: solid;
            background: var(--green-lt)
        }

        .upload-icon {
            font-size: 28px;
            margin-bottom: 6px
        }

        .upload-text {
            font-size: 13px;
            color: var(--txt3);
            font-weight: 700
        }

        .duo-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 800;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--green-dk);
            color: #fff;
            background: var(--green);
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .duo-btn:active {
            transform: translateY(4px);
            box-shadow: none
        }

        .duo-btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .duo-btn.gold {
            background: var(--gold);
            box-shadow: 0 4px 0 var(--gold-dk);
            color: var(--txt)
        }

        .duo-btn.blue {
            background: var(--blue);
            box-shadow: 0 4px 0 var(--blue-dk);
            color: #fff
        }

        .duo-btn.purple {
            background: var(--purple);
            box-shadow: 0 4px 0 #a855d6;
            color: #fff
        }

        .cta-banner {
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            box-shadow: 0 4px 0 var(--border)
        }

        .cta-banner h3 {
            font-size: 17px;
            font-weight: 900;
            margin-bottom: 6px
        }

        .cta-banner p {
            color: var(--txt2);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px
        }

        /* Launching Soon CTA */
        .notify-cta {
            border: 2px solid var(--purple);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            box-shadow: 0 4px 0 #a855d6;
            background: linear-gradient(135deg, #f3e0ff 0%, #fff 100%)
        }

        .notify-cta h3 {
            font-size: 18px;
            font-weight: 900;
            color: var(--txt);
            margin-bottom: 4px
        }

        .notify-cta .badge {
            display: inline-block;
            background: var(--purple);
            color: #fff;
            padding: 3px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 10px
        }

        .notify-cta p {
            color: var(--txt2);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px
        }

        .notify-row {
            display: flex;
            gap: 8px
        }

        .notify-input {
            flex: 1;
            padding: 14px 14px;
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 600;
            outline: none
        }

        .notify-input:focus {
            border-color: var(--purple)
        }

        .notify-submit {
            padding: 14px 20px;
            border: none;
            border-radius: 14px;
            background: var(--purple);
            color: #fff;
            font-size: 14px;
            font-weight: 800;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 3px 0 #a855d6;
            white-space: nowrap
        }

        .notify-submit:active {
            transform: translateY(3px);
            box-shadow: none
        }

        .notify-submit:disabled {
            opacity: .5
        }

        .notify-success {
            color: var(--green-dk);
            font-weight: 700;
            font-size: 13px;
            margin-top: 8px
        }

        .notify-count {
            color: var(--txt3);
            font-size: 12px;
            font-weight: 700;
            margin-top: 6px
        }

        .sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 2px
        }

        .sub-tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 800;
            font-family: inherit;
            color: var(--txt3);
            cursor: pointer;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            transition: color .2s
        }

        .sub-tab-btn.active {
            color: var(--green)
        }

        .sub-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--green);
            border-radius: 2px
        }

        .sub-tab-content {
            display: none
        }

        .sub-tab-content.active {
            display: block
        }

        .lb-row.user-row {
            border-width: 3px;
            background: var(--purple) !important;
            border-color: #a855d6 !important;
            box-shadow: 0 3px 0 #a855d6
        }

        .lb-row .user-badge {
            display: inline-block;
            background: var(--purple);
            color: #fff;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            margin-left: 6px
        }

        .medal-icon {
            font-size: 20px;
            margin-right: 4px
        }

        .lb-section {
            margin-top: 16px
        }

        .lb-title {
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--txt3);
            margin-bottom: 10px
        }

        .lb-row {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-radius: 16px;
            margin-bottom: 8px;
            border: 2px solid var(--border);
            box-shadow: 0 3px 0 var(--border)
        }

        .lb-row.first {
            border-color: var(--gold);
            background: var(--gold-lt);
            box-shadow: 0 3px 0 var(--gold-dk)
        }

        .lb-row.second {
            border-color: var(--green);
            background: var(--green-lt);
            box-shadow: 0 3px 0 var(--green-dk)
        }

        .lb-row.third {
            border-color: var(--blue);
            background: var(--blue-lt);
            box-shadow: 0 3px 0 var(--blue-dk)
        }

        .lb-rank {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 14px;
            margin-right: 12px;
            background: var(--border);
            color: var(--txt2)
        }

        .lb-row.first .lb-rank {
            background: var(--gold);
            color: #fff
        }

        .lb-row.second .lb-rank {
            background: var(--green);
            color: #fff
        }

        .lb-row.third .lb-rank {
            background: var(--blue);
            color: #fff
        }

        .lb-name {
            flex: 1;
            font-weight: 700;
            font-size: 14px
        }

        .lb-time {
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            font-size: 14px
        }

        .lb-wins {
            font-weight: 800;
            color: var(--gold-dk);
            font-size: 14px
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: var(--bg);
            border-top: 2px solid var(--border);
            padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            z-index: 100
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 2px
        }

        .nav-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .nav-item.active .nav-label {
            color: var(--green)
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: var(--green);
            border-radius: 2px
        }

        .nav-item.active {
            position: relative
        }

        .loading {
            text-align: center;
            padding: 60px 20px
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--green);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 16px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .page-content {
            padding-bottom: 80px
        }

        .next-round-card {
            text-align: center;
            padding: 40px 20px;
            border-radius: 24px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 0 var(--border)
        }

        .next-round-card .countdown {
            font-size: 44px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--blue);
            margin: 12px 0
        }

        /* ========== RESPONSIVE OPTIMIZATIONS ========== */

        /* Small screens (up to 480px) */
        @media screen and (max-width: 480px) {
            .header {
                padding: 12px 14px;
            }

            .logo-icon {
                font-size: 22px;
            }

            .logo-text {
                font-size: 16px;
            }

            .prize-badge {
                padding: 5px 12px;
                font-size: 13px;
                border-radius: 16px;
            }

            .timer-section {
                padding: 8px 14px;
            }

            .timer-value {
                font-size: 26px;
            }

            .timer-label {
                font-size: 9px;
            }

            .stat-pill {
                padding: 5px 10px;
                border-radius: 10px;
            }

            .stat-num {
                font-size: 14px;
            }

            .stat-lbl {
                font-size: 8px;
            }

            .screen {
                padding: 14px;
            }

            .stopwatch-value {
                font-size: 48px;
                letter-spacing: -2px;
            }

            .question-text {
                font-size: 15px;
                line-height: 1.5;
                margin-bottom: 16px;
            }

            .option-btn {
                padding: 14px 16px;
                border-radius: 14px;
                font-size: 14px;
            }

            .opt-letter {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }

            .result-card {
                padding: 24px 16px;
                border-radius: 20px;
                margin-bottom: 14px;
            }

            .result-icon {
                font-size: 48px;
            }

            .result-title {
                font-size: 22px;
            }

            .result-sub {
                font-size: 13px;
                margin-bottom: 14px;
            }

            .result-time {
                font-size: 42px;
            }

            .explanation-card {
                padding: 14px 16px;
                border-radius: 16px;
            }

            .explanation-text {
                font-size: 13px;
                line-height: 1.5;
            }

            .winner-form {
                padding: 16px;
                border-radius: 18px;
            }

            .winner-form h3 {
                font-size: 18px;
                margin-bottom: 14px;
            }

            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }

            .upload-area {
                padding: 16px;
            }

            .duo-btn {
                padding: 14px;
                font-size: 15px;
            }

            .cta-banner {
                padding: 16px;
                border-radius: 18px;
            }

            .cta-banner h3 {
                font-size: 16px;
            }

            .cta-banner p {
                font-size: 12px;
            }

            .notify-cta {
                padding: 16px;
                border-radius: 18px;
            }

            .notify-cta h3 {
                font-size: 16px;
            }

            .notify-cta p {
                font-size: 12px;
            }

            .notify-row {
                flex-direction: column;
                gap: 10px;
            }

            .notify-input,
            .notify-submit {
                padding: 12px 14px;
                font-size: 13px;
            }

            .lb-row {
                padding: 10px 12px;
                border-radius: 14px;
            }

            .lb-name {
                font-size: 13px;
            }

            .lb-time,
            .lb-wins {
                font-size: 13px;
            }

            h2 {
                font-size: 20px !important;
            }

            .next-round-card {
                padding: 32px 16px;
                border-radius: 20px;
            }

            .next-round-card .countdown {
                font-size: 38px;
            }

            .nav-icon {
                font-size: 20px;
            }

            .nav-label {
                font-size: 9px;
            }

            .nav-item.active::after {
                width: 36px;
                height: 3px;
            }

            .page-content {
                padding-bottom: 70px;
            }
        }

        /* Extra small screens (up to 360px) */
        @media screen and (max-width: 360px) {
            .header {
                padding: 10px 12px;
            }

            .logo-icon {
                font-size: 20px;
            }

            .logo-text {
                font-size: 15px;
            }

            .prize-badge {
                padding: 4px 10px;
                font-size: 12px;
                border-radius: 14px;
            }

            .timer-value {
                font-size: 24px;
            }

            .screen {
                padding: 12px;
            }

            .stopwatch-value {
                font-size: 42px;
            }

            .question-text {
                font-size: 14px;
                margin-bottom: 14px;
            }

            .option-btn {
                padding: 12px 14px;
                gap: 10px;
            }

            .opt-letter {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .result-card {
                padding: 20px 14px;
            }

            .result-icon {
                font-size: 42px;
            }

            .result-title {
                font-size: 20px;
            }

            .result-time {
                font-size: 36px;
            }

            .winner-form h3 {
                font-size: 17px;
            }

            .stats-row {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .stat-pill {
                min-width: 70px;
            }

            .nav-item {
                padding: 6px;
            }

            .nav-icon {
                font-size: 18px;
            }

            .nav-label {
                font-size: 8px;
            }

            .page-content {
                padding-bottom: 65px;
            }
        }

        /* Very small screens (up to 320px) */
        @media screen and (max-width: 320px) {
            .timer-value {
                font-size: 22px;
            }

            .stopwatch-value {
                font-size: 38px;
            }

            .question-chapter {
                font-size: 10px;
                padding: 3px 12px;
            }

            .option-btn {
                padding: 10px 12px;
                font-size: 13px;
            }

            .opt-letter {
                width: 28px;
                height: 28px;
            }

            .stat-pill {
                padding: 4px 8px;
                min-width: 65px;
            }

            .stat-num {
                font-size: 13px;
            }

            .result-time {
                font-size: 32px;
            }

            .notify-cta .badge {
                font-size: 10px;
                padding: 2px 10px;
            }

            .lb-name {
                font-size: 12px;
            }
        }

        /* Tablet and landscape orientation adjustments */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .option-btn {
                padding: 15px 18px;
            }

            .result-card {
                padding: 30px 24px;
            }

            .winner-form {
                padding: 24px;
            }
        }

        /* Prevent text overflow on very small screens */
        .option-btn div:last-child {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* Ensure safe area for notched phones */
        @supports (padding: max(0px)) {
            .bottom-nav {
                padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            }

            .page-content {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Improve tap targets for mobile */
        button,
        .nav-item,
        .upload-area {
            min-height: 44px;
        }

        /* Prevent zoom on input focus for iOS */
        @media screen and (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Smooth transitions for layout changes */
        .screen,
        .header,
        .timer-section,
        .bottom-nav {
            transition: all 0.2s ease;
        }

        /* Practice Mode Styles */
        .practice-round-card {
            background: var(--bg2);
            border: 2px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 3px 0 var(--border);
        }

        .practice-round-header {
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 8px;
            color: var(--txt);
        }

        .practice-round-info {
            font-size: 13px;
            color: var(--txt2);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .practice-round-btn {
            width: 100%;
            padding: 12px;
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 800;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 3px 0 var(--blue-dk);
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s;
            margin-top: 10px;
        }

        .practice-round-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        .practice-badge {
            display: inline-block;
            background: var(--blue);
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .challenge-banner {
            background: linear-gradient(135deg, var(--gold-lt) 0%, #fff8e1 100%);
            border: 2px solid var(--gold);
            border-radius: 18px;
            padding: 16px;
            margin: 0 16px 12px;
            box-shadow: 0 3px 0 var(--gold-dk);
            text-align: center;
        }

        .challenge-banner .challenge-title {
            font-size: 16px;
            font-weight: 900;
            color: var(--txt);
            margin-bottom: 6px;
        }

        .challenge-banner .challenge-info {
            font-size: 13px;
            font-weight: 700;
            color: var(--txt2);
            line-height: 1.5;
        }

        .challenge-banner .challenge-time {
            font-size: 28px;
            font-weight: 900;
            color: var(--gold-dk);
            margin: 8px 0;
        }

        .challenge-friend-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff6b35, #ff4500);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 800;
            font-family: inherit;
            margin-top: 16px;
            cursor: pointer;
            box-shadow: 0 4px 0 #cc3700;
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s;
        }

        .challenge-friend-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .challenge-friend-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .challenge-result-card {
            border: 2px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
            box-shadow: 0 3px 0 var(--border);
        }

        .challenge-result-card.challenge-won {
            background: var(--green-lt);
            border-color: var(--green);
            box-shadow: 0 3px 0 var(--green-dk);
        }

        .challenge-result-card.challenge-lost {
            background: var(--orange-lt);
            border-color: var(--orange);
            box-shadow: 0 3px 0 var(--orange);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">ü¶â</div>
            <div class="logo-text">MedicNEET</div>
        </div>
        <div class="prize-badge" id="walletBadge" onclick="switchTab('wallet')">üí∞ Wallet: ‚Çπ<span id="walletBalance">0</span></div>
    </div>
    <div class="timer-section" id="timerSection">
        <div>
            <div class="timer-label" id="timerLabel">Prize ends in</div>
            <div class="timer-value" id="roundTimer">--:--</div>
        </div>
        <div class="stats-row">
            <div class="stat-pill blue">
                <div class="stat-num" id="statFastest">--</div>
                <div class="stat-lbl">Fastest</div>
            </div>
            <div class="stat-pill orange">
                <div class="stat-num" id="statAttempts">0</div>
                <div class="stat-lbl">Playing</div>
            </div>
        </div>
    </div>
    <div id="practiceModeBanner"
        style="display:none;background:var(--orange-lt);padding:8px 16px;text-align:center;border-bottom:2px solid var(--orange)">
        <span style="font-weight:800;color:var(--orange);font-size:13px">‚è∞ PRACTICE MODE ‚Äî Prize window ended. Round ends in <span id="nextQuestionTime">--:--</span></span>
    </div>
    <div id="challengeBanner" class="challenge-banner" style="display:none;margin-top:12px">
        <div class="challenge-title" id="challengeBannerTitle"></div>
        <div class="challenge-time" id="challengeBannerTime"></div>
        <div class="challenge-info" id="challengeBannerInfo"></div>
    </div>
    <div class="page-content">
        <div class="screen active" id="loadingScreen">
            <div class="loading">
                <div class="spinner"></div>
                <p style="color:var(--txt3);font-weight:700">Loading question...</p>
            </div>
        </div>

        <div class="screen" id="quizScreen">
            <div class="stopwatch">
                <div class="stopwatch-value" id="stopwatch">0.00</div>
                <div class="stopwatch-label">Your time (seconds)</div>
            </div>
            <div id="questionsContainer"></div>
            <button class="duo-btn" id="submitBtn" onclick="submitAllAnswers()" disabled style="margin-top:20px">Submit All Answers</button>
        </div>

        <div class="screen" id="resultScreen">
            <div class="result-card" id="resultCard">
                <div class="result-icon" id="resultIcon"></div>
                <div class="result-title" id="resultTitle"></div>
                <div class="result-sub" id="resultSub"></div>
                <div class="result-time" id="resultTime"></div>
                <div class="result-time-label">seconds</div>
            </div>
            <div id="challengeResultContainer" style="display:none"></div>
            <div id="challengeShareContainer" style="display:none"></div>
            <button class="challenge-friend-btn" id="challengeFriendBtn" onclick="challengeFriend()" style="display:none">
                ‚öîÔ∏è Challenge a Friend
            </button>
            <button class="share-challenge-btn" id="shareChallengeBtn" onclick="shareChallenge()">
                üîó Share & Challenge Friends
            </button>
            <div class="explanation-card" id="explanationCard" style="display:none">
                <div class="explanation-header">üìñ Explanation</div>
                <div class="explanation-text" id="explanationText"></div>
            </div>
            <div id="questionsReviewContainer"></div>
            <div id="top10Notification" style="display:none;background:var(--green-lt);border:2px solid var(--green);border-radius:18px;padding:16px;margin-bottom:16px;text-align:center;box-shadow:0 3px 0 var(--green-dk)">
                <div style="font-size:32px;margin-bottom:8px">üéâ</div>
                <div style="font-size:18px;font-weight:900;color:var(--green-dk);margin-bottom:4px">You're in Top 10!</div>
                <div style="font-size:14px;font-weight:700;color:var(--txt2)">‚Çπ5 added to wallet</div>
            </div>
            <div class="winner-form" id="winnerForm" style="display:none">
                <h3>üèÜ Top 10 win ‚Çπ5!</h3>
                <p style="color:var(--txt2);font-size:13px;margin-bottom:14px;text-align:center">Submit your details.
                    Payment within 24 hours.</p>
                <div class="form-group"><label>Your UPI ID</label><input type="text" class="form-input" id="upiInput"
                        placeholder="name@upi or 9876543210@paytm"></div>
                <div class="form-group"><label>Your Photo (for channel announcement)</label>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">Tap to upload photo</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/jpeg,image/png" style="display:none"
                        onchange="handlePhotoUpload(this)">
                </div>
                <button class="duo-btn gold" id="claimBtn" onclick="submitWinnerDetails()" disabled>Submit Details
                    üéâ</button>
            </div>
            <div id="appCTA"></div>
            <div class="lb-section" id="roundLeaderboard"></div>
        </div>

        <div class="screen" id="leaderboardScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üèÜ TOP</h2>

            <div class="sub-tabs">
                <button class="sub-tab-btn" id="thisRoundTabBtn" onclick="switchLeaderboardTab('thisRound')">This Round</button>
                <button class="sub-tab-btn active" id="allTimeTabBtn" onclick="switchLeaderboardTab('allTime')">All Time</button>
            </div>

            <div class="sub-tab-content" id="thisRoundTab">
                <div id="thisRoundLeaderboard">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div class="sub-tab-content active" id="allTimeTab">
                <div id="allTimeLeaderboard">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div id="lbCTA"></div>
        </div>

        <div class="screen" id="historyScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üìú Recent Winners</h2>
            <div id="historyList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div class="screen" id="practiceScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üìö PRACTICE MODE</h2>
            <p style="color:var(--txt2);font-size:14px;font-weight:600;margin-bottom:16px">Solve past rounds (no prizes)</p>
            <div id="practiceRoundsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div class="screen" id="practiceQuizScreen">
            <div style="background:var(--blue-lt);padding:12px 16px;text-align:center;border-radius:16px;margin-bottom:16px;border:2px solid var(--blue)">
                <span style="font-weight:800;color:var(--blue-dk);font-size:14px">üìù PRACTICE MODE - Round #<span id="practiceRoundNumber">--</span></span>
                <div style="font-size:12px;color:var(--txt2);font-weight:700;margin-top:4px">No prizes - Practice only</div>
            </div>
            <div class="stopwatch">
                <div class="stopwatch-value" id="practiceStopwatch">0.00</div>
                <div class="stopwatch-label">Your time (seconds)</div>
            </div>
            <div id="practiceQuestionsContainer"></div>
            <button class="duo-btn blue" id="practiceSubmitBtn" onclick="submitPracticeAnswers()" disabled style="margin-top:20px">Submit All Answers</button>
        </div>

        <div class="screen" id="practiceResultScreen">
            <div class="result-card" id="practiceResultCard" style="background:var(--blue-lt);border-color:var(--blue);box-shadow:0 4px 0 var(--blue-dk)">
                <div class="result-icon">üìù</div>
                <div class="result-title" style="color:var(--blue-dk)">Practice Complete!</div>
                <div class="result-sub" id="practiceResultSub">Your Score: <span id="practiceScore">--</span>/4</div>
                <div class="result-time" style="color:var(--blue-dk)" id="practiceResultTime">0.0</div>
                <div class="result-time-label">seconds</div>
            </div>
            <div style="background:var(--bg2);border:2px solid var(--border);border-radius:18px;padding:16px;margin-bottom:16px;box-shadow:0 3px 0 var(--border)">
                <div style="font-size:14px;font-weight:800;margin-bottom:8px">üèÜ Round Winner</div>
                <div style="font-size:16px;font-weight:700;color:var(--green-dk)" id="practiceWinnerName">--</div>
                <div style="font-size:14px;color:var(--txt2);font-weight:600;margin-top:4px" id="practiceWinnerTime">--</div>
            </div>
            <div id="practiceQuestionsReview"></div>
            <button class="duo-btn blue" onclick="switchTab('practice')" style="margin-top:16px">Back to Practice Mode</button>
        </div>

        <div class="screen" id="waitingScreen">
            <div id="scheduleContainer">
                <div class="next-round-card">
                    <div style="font-size:56px">‚è≥</div>
                    <div style="font-size:20px;font-weight:900;margin-top:12px">Loading schedule...</div>
                </div>
            </div>
            <div id="waitCTA"></div>
        </div>

        <div class="screen" id="challengesScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">‚öîÔ∏è CHALLENGES</h2>

            <div class="sub-tabs">
                <button class="sub-tab-btn active" id="chalStatsTabBtn" onclick="switchChallengeTab('stats')">My Stats</button>
                <button class="sub-tab-btn" id="chalLbTabBtn" onclick="switchChallengeTab('leaderboard')">Leaderboard</button>
                <button class="sub-tab-btn" id="chalHistTabBtn" onclick="switchChallengeTab('history')">History</button>
            </div>

            <div class="sub-tab-content active" id="chalStatsTab">
                <div id="challengeStatsCard" style="background:var(--bg2);border:2px solid var(--border);border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 3px 0 var(--border)">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">‚öîÔ∏è</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Battles Won</div>
                                <div id="chalBattlesWon" style="font-size:18px;font-weight:900;color:var(--green-dk)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üíÄ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Battles Lost</div>
                                <div id="chalBattlesLost" style="font-size:18px;font-weight:900;color:var(--red)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üõ°Ô∏è</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Defended</div>
                                <div id="chalDefended" style="font-size:18px;font-weight:900;color:var(--blue-dk)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üòû</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Lost Defenses</div>
                                <div id="chalLostDef" style="font-size:18px;font-weight:900;color:var(--orange)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üî•</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Win Streak</div>
                                <div id="chalWinStreak" style="font-size:18px;font-weight:900;color:var(--gold-dk)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">‚ö°</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Best Time</div>
                                <div id="chalBestTime" style="font-size:18px;font-weight:900;color:var(--green)">--</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;grid-column:1/-1">
                            <div style="font-size:24px">üèÖ</div>
                            <div style="flex:1">
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Challenge Score</div>
                                <div style="display:flex;align-items:baseline;gap:8px">
                                    <div id="chalScore" style="font-size:22px;font-weight:900;color:var(--txt)">0</div>
                                    <div id="chalRank" style="font-size:13px;font-weight:700;color:var(--txt3)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="background:var(--blue-lt);border:2px solid var(--blue);border-radius:16px;padding:14px;text-align:center;box-shadow:0 3px 0 var(--blue-dk)">
                    <div style="font-size:13px;font-weight:700;color:var(--blue-dk)">Score = (Battles Won √ó 3) + (Defended √ó 2) - (Lost √ó 1)</div>
                </div>
            </div>

            <div class="sub-tab-content" id="chalLbTab">
                <div id="challengeLeaderboard">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="sub-tab-content" id="chalHistTab">
                <div id="challengeHistory">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <div class="screen" id="walletScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üí∞ Your Wallet</h2>

            <div class="result-card" style="background:var(--gold-lt);border-color:var(--gold);box-shadow:0 4px 0 var(--gold-dk);margin-bottom:20px">
                <div style="font-size:14px;color:var(--txt2);font-weight:700;margin-bottom:4px">Current Balance</div>
                <div style="font-size:48px;font-weight:900;color:var(--txt);line-height:1">‚Çπ<span id="walletCurrentBalance">0</span></div>
                <div style="font-size:12px;color:var(--txt3);font-weight:700;margin-top:12px">Total Earned: ‚Çπ<span id="walletTotalEarned">0</span></div>
            </div>

            <div id="statsSection" style="margin-bottom:20px">
                <h3 style="font-size:18px;font-weight:900;margin-bottom:12px">üìä YOUR STATS</h3>

                <div id="statsCard" style="background:var(--bg2);border:2px solid var(--border);border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 3px 0 var(--border)">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üèÖ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Rank</div>
                                <div id="statsRank" style="font-size:18px;font-weight:900;color:var(--txt)">--</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üí∞</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Total Earned</div>
                                <div id="statsTotalEarned" style="font-size:18px;font-weight:900;color:var(--txt)">‚Çπ0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üí≥</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Balance</div>
                                <div id="statsBalance" style="font-size:18px;font-weight:900;color:var(--txt)">‚Çπ0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">‚ö°</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Best Time</div>
                                <div id="statsBestTime" style="font-size:18px;font-weight:900;color:var(--txt)">--</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üéÆ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Rounds Played</div>
                                <div id="statsRoundsPlayed" style="font-size:18px;font-weight:900;color:var(--txt)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üèÜ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Rounds Won</div>
                                <div id="statsRoundsWon" style="font-size:18px;font-weight:900;color:var(--txt)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;grid-column:1/-1">
                            <div style="font-size:24px">üìà</div>
                            <div style="flex:1">
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Win Rate</div>
                                <div id="statsWinRate" style="font-size:18px;font-weight:900;color:var(--txt)">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="encouragementMessage" style="display:none;background:var(--blue-lt);border:2px solid var(--blue);border-radius:16px;padding:14px;text-align:center;box-shadow:0 3px 0 var(--blue-dk)">
                    <div style="font-size:14px;font-weight:700;color:var(--blue-dk)" id="encouragementText"></div>
                </div>
            </div>

            <div id="withdrawSection" style="display:none;margin-bottom:20px">
                <div class="winner-form">
                    <h3>üí∏ Withdraw Money</h3>
                    <p style="color:var(--txt2);font-size:13px;margin-bottom:14px;text-align:center">Minimum withdrawal: ‚Çπ50</p>
                    <div class="form-group">
                        <label>Your UPI ID</label>
                        <input type="text" class="form-input" id="withdrawUpiInput" placeholder="name@upi or 9876543210@paytm">
                    </div>
                    <button class="duo-btn gold" id="withdrawBtn" onclick="submitWithdrawal()" disabled>Withdraw ‚Çπ<span id="withdrawAmount">0</span></button>
                </div>
            </div>

            <div id="withdrawMinMessage" style="display:none;text-align:center;padding:20px;background:var(--orange-lt);border:2px solid var(--orange);border-radius:18px;margin-bottom:20px">
                <div style="font-size:14px;font-weight:700;color:var(--orange)">Earn ‚Çπ<span id="needMoreAmount">50</span> more to withdraw</div>
            </div>

            <div id="withdrawSuccessMessage" style="display:none;text-align:center;padding:20px;background:var(--green-lt);border:2px solid var(--green);border-radius:18px;margin-bottom:20px">
                <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
                <h3 style="margin-bottom:8px;font-size:20px">Withdrawal Requested!</h3>
                <p style="color:var(--txt2);font-size:14px;font-weight:600">You'll receive payment within 24 hours</p>
            </div>

            <div class="lb-section">
                <div class="lb-title">üíµ Transaction History</div>
                <div id="transactionsList">
                    <p style="color:var(--txt3);text-align:center;padding:20px;font-weight:700">No transactions yet</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('quiz')">
            <div class="nav-icon">‚ö°</div>
            <div class="nav-label">Quiz</div>
        </div>
        <div class="nav-item" onclick="switchTab('challenges')">
            <div class="nav-icon">‚öîÔ∏è</div>
            <div class="nav-label">Battle</div>
        </div>
        <div class="nav-item" onclick="switchTab('wallet')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-label">Wallet</div>
        </div>
        <div class="nav-item" onclick="switchTab('leaderboard')">
            <div class="nav-icon">üèÜ</div>
            <div class="nav-label">Top</div>
        </div>
        <div class="nav-item" onclick="switchTab('practice')">
            <div class="nav-icon">üìö</div>
            <div class="nav-label">Practice</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp; if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#58cc02'); tg.setBackgroundColor('#ffffff') }
        const user = tg?.initDataUnsafe?.user || { id: 'test_' + Date.now(), first_name: 'Test' };
        const userId = String(user.id), userName = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'Anonymous', initData = tg?.initData || '';
        const APP_STATUS = '{{ app_status }}', PLAYSTORE_LINK = '{{ playstore_link }}';
        let currentRound = null, stopwatchInterval = null, stopwatchStart = null, roundTimerInterval = null, hasAttempted = false, selectedPhoto = null;
        let userAnswers = [null, null, null, null];  // Track answers for 4 questions
        let submitCountdownInterval = null, submitTimeRemaining = 60;  // 60 second countdown timer
        const API = '';

        // Challenge system
        let activeChallengeCode = null;
        let challengeInfo = null;

        // Parse start_param for challenge code
        (function() {
            const startParam = tg?.initDataUnsafe?.start_param || '';
            if (startParam.startsWith('challenge_')) {
                activeChallengeCode = startParam.replace('challenge_', '');
                loadChallengeInfo(activeChallengeCode);
            }
        })();

        async function loadChallengeInfo(code) {
            try {
                const res = await fetch(`${API}/api/challenge/info?code=${code}`);
                if (!res.ok) { activeChallengeCode = null; return; }
                challengeInfo = await res.json();
                if (challengeInfo.status !== 'pending') {
                    const banner = document.getElementById('challengeBanner');
                    banner.style.display = 'block';
                    document.getElementById('challengeBannerTitle').textContent = 'Challenge ' + (challengeInfo.status === 'expired' ? 'Expired' : 'Completed');
                    document.getElementById('challengeBannerTime').textContent = '';
                    document.getElementById('challengeBannerInfo').textContent = 'This challenge is no longer active.';
                    activeChallengeCode = null;
                    return;
                }
                const banner = document.getElementById('challengeBanner');
                banner.style.display = 'block';
                const timeStr = (challengeInfo.challenger_time_ms / 1000).toFixed(1);
                const cName = challengeInfo.challenger_name;
                const nextTime = challengeInfo.next_round_time || 'Soon';
                const curRound = challengeInfo.current_round_id;
                const chalRound = challengeInfo.challenger_round_id;
                const prizeActive = challengeInfo.prize_window_active;

                if (curRound && curRound === chalRound && prizeActive) {
                    // Same round is LIVE with prize window active
                    document.getElementById('challengeBannerTitle').innerHTML = '\u{1F3C6} ' + cName + ' scored 4/4 in ' + timeStr + 's on this round!';
                    document.getElementById('challengeBannerTime').textContent = timeStr + 's';
                    document.getElementById('challengeBannerInfo').textContent = 'Beat their time!';
                } else if (curRound && curRound === chalRound && !prizeActive) {
                    // Same round but prize window over
                    document.getElementById('challengeBannerTitle').innerHTML = '\u23F0 Prize window for this round is over';
                    document.getElementById('challengeBannerTime').textContent = '';
                    document.getElementById('challengeBannerInfo').innerHTML = 'Play the next round to attempt the challenge!<br>Next round: ' + nextTime;
                } else if (curRound && curRound !== chalRound) {
                    // Different round is active - friend can play it
                    document.getElementById('challengeBannerTitle').innerHTML = '\u{1F3C6} ' + cName + ' scored 4/4 in ' + timeStr + 's!';
                    document.getElementById('challengeBannerTime').textContent = timeStr + 's';
                    document.getElementById('challengeBannerInfo').textContent = 'Play this round and beat their time!';
                } else {
                    // No round active
                    document.getElementById('challengeBannerTitle').innerHTML = '\u23F0 No round active right now';
                    document.getElementById('challengeBannerTime').textContent = '';
                    document.getElementById('challengeBannerInfo').innerHTML = 'Next round: ' + nextTime + '<br>Come back and beat ' + cName + "'s " + timeStr + 's!';
                }
            } catch (e) {
                console.error('Failed to load challenge info:', e);
                activeChallengeCode = null;
            }
        }

        async function challengeFriend() {
            const btn = document.getElementById('challengeFriendBtn');
            btn.disabled = true;
            btn.textContent = 'Creating challenge...';
            try {
                const res = await fetch(`${API}/api/challenge/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        user_name: userName,
                        round_id: currentRound.round_id,
                        time_ms: lastTimeMs
                    })
                });
                const data = await res.json();
                if (res.ok && data.challenge_code) {
                    const code = data.challenge_code;
                    const timeStr = (data.challenger_time_ms / 1000).toFixed(1);
                    const shareUrl = data.share_url;
                    const shareText = '\uD83C\uDFC6 I scored 4/4 in ' + timeStr + 's on MedicNEET Quiz! Think you\'re faster? \u2694\uFE0F Prove it!\n\n\u23F0 Rounds daily: 7:00, 7:30, 8:00, 8:30 PM IST\n\uD83D\uDC49 ' + shareUrl;
                    showChallengeShareScreen(shareUrl, shareText, timeStr);
                    btn.style.display = 'none';
                } else {
                    const errMsg = data.detail || 'Failed to create challenge';
                    alert(errMsg);
                    btn.disabled = false;
                    btn.textContent = '\u2694\uFE0F Challenge a Friend';
                }
            } catch (e) {
                console.error('Challenge create error:', e);
                alert('Failed to create challenge. Try again.');
                btn.disabled = false;
                btn.textContent = '\u2694\uFE0F Challenge a Friend';
            }
        }

        function showChallengeShareScreen(shareUrl, shareText, timeStr) {
            const container = document.getElementById('challengeShareContainer');
            const tgShareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(shareUrl) + '&text=' + encodeURIComponent(shareText);
            container.innerHTML = `
                <div style="background:linear-gradient(135deg, var(--green-lt) 0%, #e8ffe8 100%);border:2px solid var(--green);border-radius:18px;padding:20px;text-align:center;box-shadow:0 3px 0 var(--green-dk);margin-bottom:16px">
                    <div style="font-size:36px;margin-bottom:8px">\u2694\uFE0F</div>
                    <div style="font-size:18px;font-weight:900;color:var(--green-dk);margin-bottom:6px">Challenge Created!</div>
                    <div style="font-size:14px;font-weight:700;color:var(--txt2);margin-bottom:4px">Your time: ${timeStr}s</div>
                    <div style="font-size:13px;font-weight:600;color:var(--txt3)">Share with a friend to see if they can beat you!</div>
                    <div style="display:flex;gap:10px;margin-top:16px">
                        <button class="duo-btn blue" style="flex:1" onclick="window.open('${tgShareUrl}')">Share via Telegram</button>
                        <button class="duo-btn" style="flex:1" onclick="copyChallengeLink('${shareUrl}', this)">Copy Link</button>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }

        function copyChallengeLink(url, btn) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    btn.textContent = '\u2705 Copied!';
                    setTimeout(() => { btn.textContent = 'Copy Link'; }, 2000);
                }).catch(() => {
                    fallbackCopy(url);
                    btn.textContent = '\u2705 Copied!';
                    setTimeout(() => { btn.textContent = 'Copy Link'; }, 2000);
                });
            } else {
                fallbackCopy(url);
                btn.textContent = '\u2705 Copied!';
                setTimeout(() => { btn.textContent = 'Copy Link'; }, 2000);
            }
        }

        // ‚îÄ‚îÄ‚îÄ CTA BUILDER (Launching Soon vs Live) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function buildCTA(containerId) {
            const el = document.getElementById(containerId); if (!el) return;
            if (APP_STATUS === 'live' && PLAYSTORE_LINK) {
                el.innerHTML = `<div class="cta-banner"><h3>üî• Practice 2000+ Questions!</h3><p>NEET 2025 ‚Äî Statement, Sequence & Match types.</p><button class="duo-btn" onclick="window.open('${PLAYSTORE_LINK}','_blank')">Download MedicNEET ‚¨áÔ∏è</button></div>`;
            } else {
                const uid = 'notify_' + containerId;
                el.innerHTML = `
        <div class="notify-cta">
            <div class="badge">üöÄ LAUNCHING SOON</div>
            <h3>MedicNEET App</h3>
            <p>2000+ NEET 2025 style questions ‚Äî Statement,<br>Sequence & Match types. Get notified at launch!</p>
            <div class="notify-row">
                <input type="email" class="notify-input" id="${uid}" placeholder="your@email.com">
                <button class="notify-submit" onclick="submitNotifyEmail('${uid}',this)">Notify Me</button>
            </div>
            <div id="${uid}_msg"></div>
        </div>`;
            }
        }

        async function submitNotifyEmail(inputId, btn) {
            const inp = document.getElementById(inputId); const email = inp.value.trim();
            if (!email || !email.includes('@') || !email.includes('.')) {
                document.getElementById(inputId + '_msg').innerHTML = '<div style="color:var(--red);font-weight:700;font-size:13px;margin-top:8px">Please enter a valid email</div>'; return;
            }
            btn.disabled = true; btn.textContent = '...';
            try {
                const res = await fetch(`${API}/api/notify-email`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, user_id: userId, user_name: userName }) });
                const data = await res.json();
                if (data.success) {
                    document.getElementById(inputId + '_msg').innerHTML = `<div class="notify-success">‚úÖ You're in! We'll email you at launch.</div><div class="notify-count">${data.total_signups} people waiting</div>`;
                    inp.style.display = 'none'; btn.style.display = 'none';
                } else { btn.disabled = false; btn.textContent = 'Notify Me'; }
            } catch (e) { btn.disabled = false; btn.textContent = 'Notify Me' }
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id)?.classList.add('active') }
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');
            if (tab === 'quiz') { if (currentRound && !hasAttempted) showScreen('quizScreen'); else if (hasAttempted) showScreen('resultScreen'); else { showScreen('waitingScreen'); loadSchedule() } }
            else if (tab === 'wallet') { showScreen('walletScreen'); loadWallet() }
            else if (tab === 'leaderboard') { showScreen('leaderboardScreen'); loadAllTimeLeaderboard() }
            else if (tab === 'history') { showScreen('historyScreen'); loadHistory() }
            else if (tab === 'practice') { showScreen('practiceScreen'); loadPracticeRounds() }
            else if (tab === 'challenges') { showScreen('challengesScreen'); loadChallengeStats(); }
        }

        let nextRoundCountdownInterval = null;

        async function loadSchedule() {
            try {
                const res = await fetch(`${API}/api/schedule`);
                const data = await res.json();
                const container = document.getElementById('scheduleContainer');

                if (data.all_completed) {
                    container.innerHTML = `
                        <div class="next-round-card" style="border-color:var(--green);box-shadow:0 4px 0 var(--green-dk)">
                            <div style="font-size:56px">&#x2705;</div>
                            <div style="font-size:20px;font-weight:900;margin-top:12px;color:var(--green-dk)">ALL ROUNDS COMPLETED</div>
                            <div style="color:var(--txt2);font-size:14px;font-weight:700;margin-top:8px">Come back tomorrow at 7:00 PM!</div>
                            <div style="margin-top:16px">
                                <button class="duo-btn blue" onclick="switchTab('practice')">Meanwhile, practice with past rounds</button>
                            </div>
                        </div>
                        ${buildScheduleList(data.schedule)}
                        <div style="text-align:center;color:var(--txt3);font-size:12px;font-weight:700;margin-top:12px">All times in IST (Indian Standard Time)</div>
                    `;
                } else {
                    const nextSlot = data.schedule.find(s => s.status === 'upcoming');
                    const nextTimeStr = nextSlot ? nextSlot.time : 'Soon';
                    const nextTime = data.next_round_utc ? new Date(data.next_round_utc + 'Z').getTime() : null;

                    container.innerHTML = `
                        <div class="next-round-card">
                            <div style="font-size:56px">&#x23F0;</div>
                            <div style="font-size:12px;font-weight:800;color:var(--txt3);text-transform:uppercase;letter-spacing:1.5px;margin-top:8px">NEXT ROUND</div>
                            <div style="font-size:22px;font-weight:900;margin-top:4px">Today ${nextTimeStr}</div>
                            <div class="countdown" id="nextRoundCountdown">--:--:--</div>
                            <div style="color:var(--txt3);font-size:13px;font-weight:700">Starts in</div>
                        </div>
                        ${buildScheduleList(data.schedule)}
                        <div style="text-align:center;color:var(--txt3);font-size:12px;font-weight:700;margin-top:12px">All times in IST (Indian Standard Time)</div>
                    `;

                    if (nextTime) {
                        startNextRoundCountdown(nextTime);
                    }
                }

                buildCTA('waitCTA');
            } catch (e) {
                console.error('Failed to load schedule:', e);
                document.getElementById('scheduleContainer').innerHTML = `
                    <div class="next-round-card">
                        <div style="font-size:56px">&#x23F3;</div>
                        <div style="font-size:20px;font-weight:900;margin-top:12px">Loading schedule...</div>
                    </div>
                `;
                buildCTA('waitCTA');
            }
        }

        function buildScheduleList(schedule) {
            let html = '<div style="margin-top:20px;padding:16px;border:2px solid var(--border);border-radius:18px;box-shadow:0 3px 0 var(--border)">';
            html += '<div style="font-size:14px;font-weight:900;margin-bottom:12px">&#x1F4C5; Today\'s Schedule</div>';

            schedule.forEach(slot => {
                let icon, style, badge = '';
                if (slot.status === 'completed') {
                    icon = '&#x2705;';
                    style = 'color:var(--green-dk)';
                    badge = '<span style="font-size:11px;color:var(--txt3);font-weight:700;margin-left:auto">Completed</span>';
                } else if (slot.status === 'active') {
                    icon = '&#x1F534;';
                    style = 'color:var(--red);font-weight:900';
                    badge = '<span style="font-size:11px;font-weight:800;background:var(--green);color:#fff;padding:2px 8px;border-radius:8px;margin-left:auto">LIVE NOW</span>';
                } else {
                    icon = '&#x23F3;';
                    style = 'color:var(--txt)';
                    badge = '<span style="font-size:11px;color:var(--txt3);font-weight:700;margin-left:auto">Upcoming</span>';
                }

                const activeBg = slot.status === 'active' ? 'background:var(--green-lt);border-radius:10px;padding:8px 12px;margin:4px -4px' : '';
                html += `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;${activeBg}">
                    <span style="font-size:18px">${icon}</span>
                    <span style="font-weight:700;font-size:15px;${style}">${slot.time}</span>
                    ${badge}
                </div>`;
            });

            html += '</div>';
            return html;
        }

        function startNextRoundCountdown(targetTime) {
            clearInterval(nextRoundCountdownInterval);

            nextRoundCountdownInterval = setInterval(() => {
                const now = Date.now();
                const remaining = targetTime - now;

                if (remaining <= 0) {
                    clearInterval(nextRoundCountdownInterval);
                    const el = document.getElementById('nextRoundCountdown');
                    if (el) el.textContent = 'Starting...';
                    setTimeout(() => loadCurrentRound(), 3000);
                    return;
                }

                const h = Math.floor(remaining / 3600000);
                const m = Math.floor((remaining % 3600000) / 60000);
                const s = Math.floor((remaining % 60000) / 1000);

                const el = document.getElementById('nextRoundCountdown');
                if (el) el.textContent = `${h > 0 ? h + 'h ' : ''}${String(m).padStart(2, '0')}m ${String(s).padStart(2, '0')}s`;
            }, 1000);
        }

        async function loadCurrentRound() {
            try {
                const res = await fetch(`${API}/api/current-round`);
                if (!res.ok) { showScreen('waitingScreen'); loadSchedule(); return }
                const data = await res.json();
                currentRound = data;
                hasAttempted = false;
                userAnswers = [null, null, null, null];

                document.getElementById('statAttempts').textContent = data.stats.attempts;
                document.getElementById('statFastest').textContent = data.stats.fastest_time_ms ? (data.stats.fastest_time_ms / 1000).toFixed(1) + 's' : '--';
                startPrizeTimer(data.prize_ends_at, data.ends_at);

                // Build 4 questions UI
                const container = document.getElementById('questionsContainer');
                container.innerHTML = '';

                data.questions.forEach((q, idx) => {
                    const qBlock = document.createElement('div');
                    qBlock.className = 'question-block';
                    qBlock.id = `question-${idx}`;
                    qBlock.innerHTML = `
                        <div class="question-number">Question ${idx + 1}</div>
                        <div class="question-chapter">${q.chapter || 'NEET Biology'}</div>
                        <div class="question-text">${q.text}</div>
                        <div class="options">
                            <button class="option-btn" data-question="${idx}" data-answer="A" onclick="selectQuestionAnswer(${idx}, 'A', this)">
                                <div class="opt-letter">A</div>
                                <div>${q.option_a}</div>
                            </button>
                            <button class="option-btn" data-question="${idx}" data-answer="B" onclick="selectQuestionAnswer(${idx}, 'B', this)">
                                <div class="opt-letter">B</div>
                                <div>${q.option_b}</div>
                            </button>
                            <button class="option-btn" data-question="${idx}" data-answer="C" onclick="selectQuestionAnswer(${idx}, 'C', this)">
                                <div class="opt-letter">C</div>
                                <div>${q.option_c}</div>
                            </button>
                            <button class="option-btn" data-question="${idx}" data-answer="D" onclick="selectQuestionAnswer(${idx}, 'D', this)">
                                <div class="opt-letter">D</div>
                                <div>${q.option_d}</div>
                            </button>
                        </div>
                    `;
                    container.appendChild(qBlock);
                });

                document.getElementById('submitBtn').disabled = true;
                showScreen('quizScreen');
                startStopwatch();
                startSubmitCountdown();
            } catch (e) {
                console.error(e);
                showScreen('waitingScreen');
                buildCTA('waitCTA');
            }
        }

        function startStopwatch() {
            stopwatchStart = performance.now(); clearInterval(stopwatchInterval);
            stopwatchInterval = setInterval(() => { document.getElementById('stopwatch').textContent = ((performance.now() - stopwatchStart) / 1000).toFixed(2) }, 50)
        }
        function stopStopwatch() { clearInterval(stopwatchInterval); return Math.round(performance.now() - stopwatchStart) }

        function startSubmitCountdown() {
            submitTimeRemaining = 60;
            clearInterval(submitCountdownInterval);
            const submitBtn = document.getElementById('submitBtn');

            // Initial state - disabled with countdown
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            updateSubmitButtonText();

            submitCountdownInterval = setInterval(() => {
                submitTimeRemaining--;

                if (submitTimeRemaining > 0) {
                    updateSubmitButtonText();
                } else {
                    // Countdown complete
                    clearInterval(submitCountdownInterval);
                    submitBtn.textContent = 'Submit All Answers';
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';

                    // Enable button only if all questions are answered
                    const allAnswered = userAnswers.every(a => a !== null);
                    submitBtn.disabled = !allAnswered;
                }
            }, 1000);
        }

        function updateSubmitButtonText() {
            const submitBtn = document.getElementById('submitBtn');
            const seconds = submitTimeRemaining;
            const display = `0:${String(seconds).padStart(2, '0')}`;
            submitBtn.textContent = `Submit in ${display}`;
        }

        let prizeWindowActive = true;
        function startPrizeTimer(prizeEndsAt, roundEndsAt) {
            clearInterval(roundTimerInterval);
            const prizeEnd = prizeEndsAt ? new Date(prizeEndsAt + 'Z').getTime() : 0;
            const roundEnd = new Date(roundEndsAt + 'Z').getTime();

            roundTimerInterval = setInterval(() => {
                const now = Date.now();
                const prizeRemaining = prizeEnd - now;
                const roundRemaining = roundEnd - now;

                if (roundRemaining <= 0) {
                    clearInterval(roundTimerInterval);
                    document.getElementById('roundTimer').textContent = '00:00';
                    if (!hasAttempted) {
                        showScreen('waitingScreen');
                        loadSchedule();
                    }
                    return;
                }

                if (prizeRemaining > 0) {
                    // Prize window still active
                    prizeWindowActive = true;
                    document.getElementById('timerSection').style.display = 'flex';
                    document.getElementById('practiceModeBanner').style.display = 'none';
                    document.getElementById('timerLabel').textContent = 'üí∞ PRIZE ENDS IN';
                    const m = Math.floor(prizeRemaining / 60000);
                    const s = Math.floor((prizeRemaining % 60000) / 1000);
                    document.getElementById('roundTimer').textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    if (prizeRemaining < 30000) document.getElementById('roundTimer').classList.add('danger');
                    else document.getElementById('roundTimer').classList.remove('danger');
                } else {
                    // Practice mode
                    prizeWindowActive = false;
                    document.getElementById('timerSection').style.display = 'none';
                    document.getElementById('practiceModeBanner').style.display = 'block';
                    const h = Math.floor(roundRemaining / 3600000);
                    const m = Math.floor((roundRemaining % 3600000) / 60000);
                    const s = Math.floor((roundRemaining % 60000) / 1000);
                    document.getElementById('nextQuestionTime').textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                }
            }, 1000);
        }

        function selectQuestionAnswer(questionIdx, answer, btn) {
            if (hasAttempted) return;

            // Remove selection from other options in this question
            const questionBlock = document.getElementById(`question-${questionIdx}`);
            questionBlock.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.background = 'var(--bg)';
                b.style.borderColor = 'var(--border)';
            });

            // Mark this option as selected
            btn.classList.add('selected');
            btn.style.background = 'var(--blue-lt)';
            btn.style.borderColor = 'var(--blue)';

            // Store the answer
            userAnswers[questionIdx] = answer;

            // Mark question block as answered
            questionBlock.classList.add('answered');

            // Enable submit button if all 4 questions are answered AND countdown is complete
            const allAnswered = userAnswers.every(a => a !== null);
            const submitBtn = document.getElementById('submitBtn');

            // Only enable if countdown is complete (submitTimeRemaining <= 0)
            if (submitTimeRemaining <= 0 && allAnswered) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        let lastTimeMs = 0;

        async function submitAllAnswers() {
            if (hasAttempted) return;
            hasAttempted = true;
            const tms = stopStopwatch();
            lastTimeMs = tms;

            document.getElementById('submitBtn').disabled = true;
            document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');

            try {
                const submitBody = {
                    round_id: currentRound.round_id,
                    user_id: userId,
                    user_name: userName,
                    answers: userAnswers,
                    time_ms: tms,
                    init_data: initData
                };
                if (activeChallengeCode) {
                    submitBody.challenge_code = activeChallengeCode;
                }
                const res = await fetch(`${API}/api/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submitBody)
                });

                if (res.status === 400) {
                    const err = await res.json();
                    if (err.detail === 'Already attempted') {
                        showAlreadyAttempted();
                        return;
                    }
                }

                const data = await res.json();

                // During prize window, don't reveal which answers were correct/wrong
                // to prevent multi-account cheating
                if (!data.prize_window_active && data.results) {
                    data.results.forEach((isCorrect, idx) => {
                        const questionBlock = document.getElementById(`question-${idx}`);
                        questionBlock.classList.add(isCorrect ? 'correct' : 'incorrect');

                        const buttons = questionBlock.querySelectorAll('.option-btn');
                        buttons.forEach(btn => {
                            const btnAnswer = btn.dataset.answer;
                            if (btnAnswer === data.correct_answers[idx]) {
                                btn.classList.add('correct');
                            } else if (btnAnswer === userAnswers[idx] && !isCorrect) {
                                btn.classList.add('wrong');
                            }
                        });
                    });
                }

                setTimeout(() => showResult(data, tms), 1200);
            } catch (e) {
                console.error(e);
                hasAttempted = false;
                document.getElementById('submitBtn').disabled = false;
                document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'auto');
            }
        }

        function showResult(data, tms) {
            const ts = (tms / 1000).toFixed(2);
            const card = document.getElementById('resultCard');
            const inPrizeWindow = data.prize_window_active === true;
            const correctCount = inPrizeWindow ? (data.score || 0) : (data.results ? data.results.filter(r => r).length : 0);
            const allCorrect = data.all_correct;

            // Store for sharing
            lastScore = correctCount;
            lastTime = ts;

            if (data.is_current_winner && inPrizeWindow) {
                card.className = 'result-card win';
                document.getElementById('resultIcon').textContent = 'üèÜ';
                document.getElementById('resultTitle').textContent = "YOU'RE WINNING!";
                document.getElementById('resultTitle').className = 'result-title win-text';
                document.getElementById('resultSub').textContent = 'Solved 4/4 correctly ‚Äî fastest time! Top 10 win ‚Çπ5!';
                document.getElementById('winnerForm').style.display = 'block';
                document.getElementById('resultTime').style.color = 'var(--green)';
            }
            else if (allCorrect && inPrizeWindow) {
                card.className = 'result-card correct';
                document.getElementById('resultIcon').textContent = '‚úÖ';
                document.getElementById('resultTitle').textContent = 'All Correct!';
                document.getElementById('resultTitle').className = 'result-title correct-text';
                document.getElementById('resultSub').textContent = 'Solved 4/4 ‚Äî Someone was faster. Try next round!';
                document.getElementById('winnerForm').style.display = 'none';
                document.getElementById('resultTime').style.color = 'var(--green-dk)';
            }
            else if (allCorrect && !inPrizeWindow) {
                card.className = 'result-card correct';
                document.getElementById('resultIcon').textContent = '‚úÖ';
                document.getElementById('resultTitle').textContent = 'All Correct!';
                document.getElementById('resultTitle').className = 'result-title correct-text';
                document.getElementById('resultSub').textContent = 'Practice mode ‚Äî Solved 4/4! Nice revision!';
                document.getElementById('winnerForm').style.display = 'none';
                document.getElementById('resultTime').style.color = 'var(--green-dk)';
            }
            else {
                card.className = 'result-card wrong';
                document.getElementById('resultIcon').textContent = '‚ùå';
                document.getElementById('resultTitle').textContent = `${correctCount}/4 Correct`;
                document.getElementById('resultTitle').className = 'result-title wrong-text';
                document.getElementById('resultSub').textContent = inPrizeWindow ? 'Need all 4 correct to win!' : 'Practice mode ‚Äî Need all 4 correct to win!';
                document.getElementById('winnerForm').style.display = 'none';
                document.getElementById('resultTime').style.color = 'var(--txt)';
            }

            document.getElementById('resultTime').textContent = ts;

            // During prize window, hide explanations and per-question breakdown
            // to prevent multi-account cheating
            const expCard = document.getElementById('explanationCard');
            const reviewContainer = document.getElementById('questionsReviewContainer');

            if (inPrizeWindow) {
                // Prize window active: only show score summary, no details
                expCard.style.display = 'none';
                reviewContainer.innerHTML = `<div style="background:var(--bg2);border:2px solid var(--border);border-radius:16px;padding:18px;margin-bottom:10px;box-shadow:0 3px 0 var(--border);text-align:center">
                    <div style="font-size:15px;font-weight:800;color:var(--txt);margin-bottom:6px">You got ${correctCount}/4 correct</div>
                    <div style="font-size:13px;font-weight:600;color:var(--txt2)">Detailed results and explanations will be available after the prize window ends.</div>
                </div>`;
            } else {
                // Prize window ended: show full breakdown
                let hasExplanations = false;
                let expHTML = '<div class="explanation-header">üìñ Explanations</div>';

                if (data.explanations) {
                    data.explanations.forEach((exp, idx) => {
                        if (!data.results[idx] && exp?.trim()) {
                            hasExplanations = true;
                            expHTML += `<div style="margin-bottom:12px"><strong>Q${idx + 1}:</strong> Correct answer was ${data.correct_answers[idx]}. ${exp}</div>`;
                        }
                    });
                }

                if (hasExplanations) {
                    expCard.innerHTML = expHTML;
                    expCard.style.display = 'block';
                } else {
                    expCard.style.display = 'none';
                }

                if (currentRound?.questions && data.results) {
                    let reviewHTML = '<div style="margin-bottom:16px">';
                    currentRound.questions.forEach((q, idx) => {
                        const isCorrect = data.results[idx];
                        const userAnswer = userAnswers[idx];
                        const correctAnswer = data.correct_answers[idx];
                        const icon = isCorrect ? '‚úÖ' : '‚ùå';

                        reviewHTML += `
                            <div style="background:var(--bg2);border:2px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:0 3px 0 var(--border)">
                                <div style="font-size:14px;font-weight:800;color:var(--txt);margin-bottom:6px">
                                    ${icon} Question ${idx + 1}/4
                                </div>
                                <div style="font-size:13px;font-weight:600;color:var(--txt2);margin-bottom:4px">
                                    Your answer: <strong>${userAnswer || 'None'}</strong>
                                </div>
                                ${!isCorrect ? `<div style="font-size:13px;font-weight:700;color:var(--green-dk)">
                                    Correct answer: <strong>${correctAnswer}</strong>
                                </div>` : ''}
                            </div>
                        `;
                    });
                    reviewHTML += '</div>';
                    reviewContainer.innerHTML = reviewHTML;
                } else {
                    reviewContainer.innerHTML = '';
                }
            }

            // Show "Challenge a Friend" button if 4/4 correct (and no challenge result to show)
            const challengeBtn = document.getElementById('challengeFriendBtn');
            const shareBtn = document.getElementById('shareChallengeBtn');
            if (allCorrect && !data.challenge_result) {
                challengeBtn.style.display = 'block';
                shareBtn.style.display = 'none';
            } else if (!allCorrect && !data.challenge_result) {
                challengeBtn.style.display = 'none';
                shareBtn.style.display = 'block';
            } else {
                // Challenge result present - buttons managed by challenge result logic below
                challengeBtn.style.display = 'none';
                shareBtn.style.display = 'none';
            }

            // Show challenge result if present
            const challengeResultContainer = document.getElementById('challengeResultContainer');
            const challengeShareContainer = document.getElementById('challengeShareContainer');
            challengeShareContainer.style.display = 'none';
            challengeShareContainer.innerHTML = '';
            if (data.challenge_result) {
                const cr = data.challenge_result;
                const challengerTimeStr = (cr.challenger_time_ms / 1000).toFixed(1);
                const yourTimeStr = (cr.your_time_ms / 1000).toFixed(1);
                let crHTML = '';
                if (cr.status === 'won') {
                    // Friend won - beat the challenger
                    crHTML = `<div class="challenge-result-card challenge-won">
                        <div style="font-size:36px;margin-bottom:8px">\uD83D\uDD25</div>
                        <div style="font-size:18px;font-weight:900;color:var(--green-dk);margin-bottom:6px">You beat ${cr.challenger_name}!</div>
                        <div style="font-size:14px;font-weight:700;color:var(--txt2)">${yourTimeStr}s vs their ${challengerTimeStr}s</div>
                    </div>`;
                    // Show chain share button
                    if (cr.chain_challenge_code && cr.chain_challenge_url) {
                        const chainShareText = '\uD83D\uDD25 I defeated ' + cr.challenger_name + ' on MedicNEET Quiz! Beat MY time of ' + yourTimeStr + 's if you can! \u2694\uFE0F\n\n\u23F0 Rounds daily: 7:00, 7:30, 8:00, 8:30 PM IST\n\uD83D\uDC49 ' + cr.chain_challenge_url;
                        const chainTgUrl = 'https://t.me/share/url?url=' + encodeURIComponent(cr.chain_challenge_url) + '&text=' + encodeURIComponent(chainShareText);
                        challengeShareContainer.innerHTML = `
                            <div style="background:linear-gradient(135deg, var(--gold-lt) 0%, #fff8e1 100%);border:2px solid var(--gold);border-radius:18px;padding:20px;text-align:center;box-shadow:0 3px 0 var(--gold-dk);margin-bottom:16px">
                                <div style="font-size:16px;font-weight:900;color:var(--txt);margin-bottom:10px">Share your victory!</div>
                                <div style="display:flex;gap:10px">
                                    <button class="duo-btn blue" style="flex:1" onclick="window.open('${chainTgUrl}')">Share via Telegram</button>
                                    <button class="duo-btn" style="flex:1" onclick="copyChallengeLink('${cr.chain_challenge_url}', this)">Copy Link</button>
                                </div>
                            </div>
                        `;
                        challengeShareContainer.style.display = 'block';
                    }
                    // Hide the normal challenge button since chain is auto-created
                    challengeBtn.style.display = 'none';
                } else if (cr.status === 'lost') {
                    // Friend lost - challenger retains the win
                    crHTML = `<div class="challenge-result-card challenge-lost">
                        <div style="font-size:36px;margin-bottom:8px">\uD83D\uDC80</div>
                        <div style="font-size:18px;font-weight:900;color:var(--orange);margin-bottom:6px">So close!</div>
                        <div style="font-size:14px;font-weight:700;color:var(--txt2)">You got 4/4 but ${cr.challenger_name}'s ${challengerTimeStr}s was faster. Your time: ${yourTimeStr}s</div>
                        <button class="duo-btn blue" style="margin-top:12px" onclick="switchTab('quiz')">Try again next round</button>
                    </div>`;
                    challengeBtn.style.display = 'none';
                }
                challengeResultContainer.innerHTML = crHTML;
                challengeResultContainer.style.display = 'block';
            } else if (activeChallengeCode && !allCorrect) {
                challengeResultContainer.innerHTML = `<div class="challenge-result-card">
                    <div style="font-size:36px;margin-bottom:8px">\uD83D\uDCAA</div>
                    <div style="font-size:16px;font-weight:900;color:var(--txt);margin-bottom:6px">You need 4/4 correct first!</div>
                    <div style="font-size:14px;font-weight:700;color:var(--txt2)">Try again next round.</div>
                </div>`;
                challengeResultContainer.style.display = 'block';
            } else {
                challengeResultContainer.style.display = 'none';
            }

            // Check for top 10 placement
            const top10Notif = document.getElementById('top10Notification');
            if (data.rank && data.rank <= 10 && inPrizeWindow && allCorrect && !data.is_current_winner) {
                top10Notif.style.display = 'block';
            } else {
                top10Notif.style.display = 'none';
            }

            buildCTA('appCTA');
            buildRoundLeaderboard(data.leaderboard);

            // Reload wallet if user won
            if (data.is_current_winner || allCorrect) {
                loadWallet();
            }

            if (tg?.HapticFeedback) {
                if (data.is_current_winner) tg.HapticFeedback.notificationOccurred('success');
                else if (allCorrect) tg.HapticFeedback.notificationOccurred('warning');
                else tg.HapticFeedback.notificationOccurred('error');
            }

            showScreen('resultScreen');
        }

        function showAlreadyAttempted() {
            const card = document.getElementById('resultCard'); card.className = 'result-card';
            document.getElementById('resultIcon').textContent = '‚è∞'; document.getElementById('resultTitle').textContent = 'Already Played';
            document.getElementById('resultTitle').className = 'result-title'; document.getElementById('resultSub').textContent = 'Next question coming soon!';
            document.getElementById('resultTime').textContent = '--'; document.getElementById('winnerForm').style.display = 'none';
            document.getElementById('explanationCard').style.display = 'none'; document.getElementById('roundLeaderboard').innerHTML = ''; buildCTA('appCTA'); showScreen('resultScreen')
        }

        function buildRoundLeaderboard(lb) {
            const c = document.getElementById('roundLeaderboard'); if (!lb?.length) { c.innerHTML = ''; return }
            let h = '<div class="lb-title">‚ö° This Round ‚Äî Fastest Correct</div>';
            lb.forEach((e, i) => {
                const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : ''; const me = e.user_name === userName;
                h += `<div class="lb-row ${cls}" ${me ? 'style="border-width:3px"' : ''}><div class="lb-rank">${i + 1}</div><div class="lb-name">${e.user_name}${me ? ' (You)' : ''}</div><div class="lb-time">${(e.time_ms / 1000).toFixed(2)}s</div></div>`
            }); c.innerHTML = h
        }

        function switchLeaderboardTab(tab) {
            // Update tab buttons
            document.getElementById('thisRoundTabBtn').classList.remove('active');
            document.getElementById('allTimeTabBtn').classList.remove('active');

            // Update tab content
            document.getElementById('thisRoundTab').classList.remove('active');
            document.getElementById('allTimeTab').classList.remove('active');

            if (tab === 'thisRound') {
                document.getElementById('thisRoundTabBtn').classList.add('active');
                document.getElementById('thisRoundTab').classList.add('active');
                loadThisRoundLeaderboard();
            } else {
                document.getElementById('allTimeTabBtn').classList.add('active');
                document.getElementById('allTimeTab').classList.add('active');
                loadAllTimeLeaderboard();
            }
        }

        async function loadThisRoundLeaderboard() {
            try {
                const res = await fetch(`${API}/api/leaderboard`);
                const data = await res.json();
                const c = document.getElementById('thisRoundLeaderboard');

                if (!data.leaderboard?.length) {
                    c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No winners yet!</p>';
                    return;
                }

                let h = '';
                data.leaderboard.forEach((e, i) => {
                    const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : '';
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    h += `<div class="lb-row ${cls}">
                        <div class="lb-rank">${medal || i + 1}</div>
                        <div class="lb-name">${e.user_name}</div>
                        <div class="lb-wins">${e.wins} üèÜ</div>
                        <div class="lb-time" style="margin-left:10px">‚Çπ${e.total_won}</div>
                    </div>`;
                });
                c.innerHTML = h;
            } catch (e) {
                console.error(e);
            }
        }

        async function loadAllTimeLeaderboard() {
            try {
                const res = await fetch(`${API}/api/leaderboard/alltime?user_id=${userId}`);
                const data = await res.json();
                const c = document.getElementById('allTimeLeaderboard');

                if (!data.leaderboard?.length) {
                    c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No winners yet!</p>';
                    buildCTA('lbCTA');
                    return;
                }

                let h = '<div style="text-align:center;margin-bottom:16px;font-size:28px;font-weight:900">üèÜ ALL-TIME LEADERBOARD</div>';

                data.leaderboard.forEach((e, i) => {
                    const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : '';
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    const isCurrentUser = e.user_id === userId;
                    const userCls = isCurrentUser ? 'user-row' : '';
                    const userBadge = isCurrentUser ? '<span class="user-badge">YOU</span>' : '';
                    const bestTime = e.best_time ? (e.best_time / 1000).toFixed(1) + 's' : '--';

                    h += `<div class="lb-row ${cls} ${userCls}">
                        ${medal ? `<span class="medal-icon">${medal}</span>` : `<div class="lb-rank">${e.rank}</div>`}
                        <div class="lb-name">${e.user_name}${userBadge}</div>
                        <div class="lb-time" style="margin-left:auto;margin-right:10px">‚Çπ${e.total_earned}</div>
                        <div class="lb-time" style="color:var(--txt3)">${bestTime}</div>
                    </div>`;
                });

                c.innerHTML = h;
                buildCTA('lbCTA');
            } catch (e) {
                console.error(e);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${API}/api/history`); const data = await res.json(); const c = document.getElementById('historyList');
                if (!data.history?.length) { c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No rounds yet.</p>'; return }
                let h = ''; data.history.forEach(e => { h += `<div class="lb-row" style="flex-direction:column;align-items:flex-start;gap:4px"><div style="font-size:12px;color:var(--txt3);font-weight:700">${e.chapter || 'Biology'}</div><div style="font-size:14px;font-weight:700">${e.question.substring(0, 80)}...</div><div style="display:flex;justify-content:space-between;width:100%"><span style="color:var(--gold-dk);font-weight:800">üèÜ ${e.winner_name || 'No winner'}</span><span style="color:var(--green);font-weight:800">${e.winner_time_ms ? (e.winner_time_ms / 1000).toFixed(1) + 's' : '--'}</span></div></div>` }); c.innerHTML = h
            } catch (e) { }
        }

        // ‚îÄ‚îÄ‚îÄ PRACTICE MODE FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let practiceRoundData = null;
        let practiceAnswers = [null, null, null, null];
        let practiceStopwatchStart = null;
        let practiceStopwatchInterval = null;

        async function loadPracticeRounds() {
            try {
                const res = await fetch(`${API}/api/rounds/history`);
                const data = await res.json();
                const container = document.getElementById('practiceRoundsList');

                if (!data.rounds || data.rounds.length === 0) {
                    container.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No past rounds available yet.</p>';
                    return;
                }

                container.innerHTML = data.rounds.map(round => {
                    const date = new Date(round.date + 'Z');
                    const dateStr = date.toLocaleString('en-IN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const winnerTime = round.winning_time ? (round.winning_time / 1000).toFixed(1) + 's' : 'N/A';

                    return `
                        <div class="practice-round-card">
                            <div class="practice-round-header">Round #${round.round_id} - ${dateStr}</div>
                            <div class="practice-round-info">üèÜ Winner: ${round.winner_name} (${winnerTime})</div>
                            <div class="practice-round-info">üë• ${round.total_participants} participants</div>
                            <button class="practice-round-btn" onclick="startPracticeRound(${round.round_id})">Practice This Round</button>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load practice rounds:', e);
                document.getElementById('practiceRoundsList').innerHTML = '<p style="color:var(--red);text-align:center;padding:40px;font-weight:700">Failed to load rounds. Please try again.</p>';
            }
        }

        async function startPracticeRound(roundId) {
            try {
                showScreen('loadingScreen');
                const res = await fetch(`${API}/api/rounds/practice?round_id=${roundId}`);
                const data = await res.json();

                practiceRoundData = data;
                practiceAnswers = [null, null, null, null];

                document.getElementById('practiceRoundNumber').textContent = roundId;

                const container = document.getElementById('practiceQuestionsContainer');
                container.innerHTML = data.questions.map((q, idx) => `
                    <div class="question-block" id="practice-q-${idx}">
                        <div class="question-number">Question ${idx + 1}/4</div>
                        <div class="question-chapter">${q.chapter}</div>
                        <div class="question-text">${q.text}</div>
                        <div class="options">
                            <button class="option-btn" onclick="selectPracticeAnswer(${idx}, 'A')">
                                <div class="opt-letter">A</div>
                                <div>${q.option_a}</div>
                            </button>
                            <button class="option-btn" onclick="selectPracticeAnswer(${idx}, 'B')">
                                <div class="opt-letter">B</div>
                                <div>${q.option_b}</div>
                            </button>
                            <button class="option-btn" onclick="selectPracticeAnswer(${idx}, 'C')">
                                <div class="opt-letter">C</div>
                                <div>${q.option_c}</div>
                            </button>
                            <button class="option-btn" onclick="selectPracticeAnswer(${idx}, 'D')">
                                <div class="opt-letter">D</div>
                                <div>${q.option_d}</div>
                            </button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('practiceSubmitBtn').disabled = true;
                showScreen('practiceQuizScreen');

                // Start stopwatch
                practiceStopwatchStart = Date.now();
                clearInterval(practiceStopwatchInterval);
                practiceStopwatchInterval = setInterval(() => {
                    const elapsed = (Date.now() - practiceStopwatchStart) / 1000;
                    document.getElementById('practiceStopwatch').textContent = elapsed.toFixed(2);
                }, 10);

            } catch (e) {
                console.error('Failed to start practice round:', e);
                alert('Failed to load practice round. Please try again.');
                showScreen('practiceScreen');
            }
        }

        function selectPracticeAnswer(questionIndex, answer) {
            practiceAnswers[questionIndex] = answer;

            // Update UI
            const block = document.getElementById(`practice-q-${questionIndex}`);
            const buttons = block.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                const letter = btn.querySelector('.opt-letter').textContent;
                if (letter === answer) {
                    btn.style.borderColor = 'var(--blue)';
                    btn.style.background = 'var(--blue-lt)';
                    btn.querySelector('.opt-letter').style.background = 'var(--blue)';
                    btn.querySelector('.opt-letter').style.borderColor = 'var(--blue-dk)';
                    btn.querySelector('.opt-letter').style.color = '#fff';
                } else {
                    btn.style.borderColor = '';
                    btn.style.background = '';
                    btn.querySelector('.opt-letter').style.background = '';
                    btn.querySelector('.opt-letter').style.borderColor = '';
                    btn.querySelector('.opt-letter').style.color = '';
                }
            });

            block.classList.add('answered');

            // Enable submit if all answered
            const allAnswered = practiceAnswers.every(a => a !== null);
            document.getElementById('practiceSubmitBtn').disabled = !allAnswered;
        }

        async function submitPracticeAnswers() {
            clearInterval(practiceStopwatchInterval);
            const timeMs = Date.now() - practiceStopwatchStart;

            try {
                const res = await fetch(`${API}/api/rounds/practice/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        round_id: practiceRoundData.round_id,
                        answers: practiceAnswers,
                        time_ms: timeMs
                    })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    console.error('Practice submit failed:', res.status, errText);
                    alert(`Server error (${res.status}). Please try again.`);
                    return;
                }

                const data = await res.json();

                // Show results
                document.getElementById('practiceScore').textContent = data.score;
                document.getElementById('practiceResultSub').innerHTML = `Your Score: <span style="font-weight:900;color:var(--blue-dk)">${data.score}/4</span>`;
                document.getElementById('practiceResultTime').textContent = (timeMs / 1000).toFixed(1);

                // Show winner info
                if (data.round_winner_name) {
                    document.getElementById('practiceWinnerName').textContent = data.round_winner_name;
                    const winnerTime = data.round_winner_time_ms ? (data.round_winner_time_ms / 1000).toFixed(1) + 's' : 'N/A';
                    document.getElementById('practiceWinnerTime').textContent = `Completed in ${winnerTime}`;
                } else {
                    document.getElementById('practiceWinnerName').textContent = 'No winner';
                    document.getElementById('practiceWinnerTime').textContent = 'Nobody scored 4/4';
                }

                // Show questions review
                const reviewContainer = document.getElementById('practiceQuestionsReview');
                reviewContainer.innerHTML = practiceRoundData.questions.map((q, idx) => {
                    const userAnswer = practiceAnswers[idx];
                    const correctAnswer = data.correct_answers[idx];
                    const isCorrect = data.results[idx];
                    const explanation = data.explanations[idx];

                    return `
                        <div class="question-block ${isCorrect ? 'correct' : 'incorrect'}">
                            <div class="question-number">Question ${idx + 1}/4 ${isCorrect ? '‚úÖ' : '‚ùå'}</div>
                            <div class="question-chapter">${q.chapter}</div>
                            <div class="question-text">${q.text}</div>
                            <div class="options">
                                ${['A', 'B', 'C', 'D'].map(letter => {
                                    const isUserAnswer = letter === userAnswer;
                                    const isCorrectAnswer = letter === correctAnswer;
                                    let className = 'option-btn';
                                    if (isCorrectAnswer) className += ' correct';
                                    else if (isUserAnswer && !isCorrect) className += ' wrong';

                                    const optionText = q[`option_${letter.toLowerCase()}`];
                                    return `
                                        <div class="${className}">
                                            <div class="opt-letter">${letter}</div>
                                            <div>${optionText}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${explanation ? `
                                <div class="explanation-card">
                                    <div class="explanation-header">üìñ Explanation</div>
                                    <div class="explanation-text">${explanation}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                showScreen('practiceResultScreen');

            } catch (e) {
                console.error('Practice submit error:', e);
                alert('Network error ‚Äî check your connection and try again.');
            }
        }

        function handlePhotoUpload(input) {
            const f = input.files[0]; if (!f) return; selectedPhoto = f; const a = document.getElementById('uploadArea');
            a.classList.add('has-file'); a.innerHTML = `<div class="upload-icon">‚úÖ</div><div class="upload-text">${f.name}</div>`; checkClaimReady()
        }
        function checkClaimReady() { document.getElementById('claimBtn').disabled = !(document.getElementById('upiInput').value.trim() && selectedPhoto) }
        document.getElementById('upiInput')?.addEventListener('input', checkClaimReady);

        async function submitWinnerDetails() {
            const btn = document.getElementById('claimBtn'); btn.disabled = true; btn.textContent = 'Uploading...';
            const fd = new FormData(); fd.append('round_id', currentRound.round_id); fd.append('user_id', userId);
            fd.append('upi_id', document.getElementById('upiInput').value.trim()); fd.append('photo', selectedPhoto);
            try {
                const res = await fetch(`${API}/api/winner-photo`, { method: 'POST', body: fd }); const data = await res.json();
                if (data.success) { document.getElementById('winnerForm').innerHTML = `<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:12px">‚úÖ</div><h3 style="margin-bottom:8px;font-size:20px">Details Submitted!</h3><p style="color:var(--txt2);font-size:14px;font-weight:600">‚Çπ5 will be sent to your UPI within 24 hours.</p><p style="color:var(--green-dk);font-size:13px;font-weight:700;margin-top:8px">You'll be announced on the channel now! üéâ</p></div>` }
                else { btn.textContent = 'Submit Details üéâ'; btn.disabled = false }
            }
            catch (e) { btn.textContent = 'Submit Details üéâ'; btn.disabled = false }
        }

        let lastScore = 0;
        let lastTime = '0.00';

        async function shareChallenge() {
            const shareText = `üß† I scored ${lastScore}/4 in ${lastTime}s on MedicNEET Quiz! Can you beat me? üëâ https://t.me/Winners_neetbot/Medicneet`;

            // Try using navigator.share() for mobile
            if (navigator.share) {
                try {
                    await navigator.share({
                        text: shareText
                    });
                } catch (err) {
                    // User cancelled or error occurred, fall back to clipboard
                    if (err.name !== 'AbortError') {
                        copyToClipboard(shareText);
                    }
                }
            } else {
                // Fall back to clipboard copy on desktop
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied! Share with friends');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Copied! Share with friends');
            } catch (err) {
                alert('Could not copy. Please share manually.');
            }
            document.body.removeChild(textarea);
        }

        async function loadWallet() {
            try {
                const res = await fetch(`${API}/api/wallet?user_id=${userId}`);
                const data = await res.json();

                const balance = data.balance || 0;
                const totalEarned = data.total_earned || 0;

                // Update header badge
                document.getElementById('walletBalance').textContent = balance;

                // Update wallet screen
                document.getElementById('walletCurrentBalance').textContent = balance;
                document.getElementById('walletTotalEarned').textContent = totalEarned;

                // Show/hide withdraw section based on balance
                if (balance >= 50) {
                    document.getElementById('withdrawSection').style.display = 'block';
                    document.getElementById('withdrawMinMessage').style.display = 'none';
                    document.getElementById('withdrawAmount').textContent = balance;
                    document.getElementById('withdrawUpiInput').value = data.upi_id || '';
                    checkWithdrawReady();
                } else {
                    document.getElementById('withdrawSection').style.display = 'none';
                    document.getElementById('withdrawMinMessage').style.display = 'block';
                    document.getElementById('needMoreAmount').textContent = 50 - balance;
                }

                // Display transactions
                const txList = document.getElementById('transactionsList');
                if (data.transactions && data.transactions.length > 0) {
                    let txHTML = '';
                    data.transactions.forEach(tx => {
                        const date = new Date(tx.created_at).toLocaleDateString();
                        txHTML += `<div class="lb-row" style="background:var(--green-lt);border-color:var(--green)">
                            <div style="flex:1">
                                <div style="font-weight:700;font-size:14px">Round #${tx.round_id || '?'}</div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700">${date}</div>
                            </div>
                            <div style="font-weight:800;font-size:16px;color:var(--green)">+‚Çπ${tx.amount}</div>
                        </div>`;
                    });
                    txList.innerHTML = txHTML;
                } else {
                    txList.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:20px;font-weight:700">No transactions yet</p>';
                }

                // Load stats
                loadStats();
            } catch (e) {
                console.error('Failed to load wallet:', e);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API}/api/stats?user_id=${userId}`);
                const data = await res.json();

                // Update rank with color based on position
                const rankEl = document.getElementById('statsRank');
                const statsCard = document.getElementById('statsCard');

                if (data.rank && data.total_players > 0) {
                    rankEl.textContent = `#${data.rank} of ${data.total_players}`;

                    // Color coding based on rank
                    if (data.rank <= 10) {
                        rankEl.style.color = 'var(--gold)';
                        statsCard.style.borderColor = 'var(--gold)';
                        statsCard.style.background = 'var(--gold-lt)';
                        statsCard.style.boxShadow = '0 3px 0 var(--gold-dk)';
                    } else if (data.rank <= 50) {
                        rankEl.style.color = 'var(--green)';
                        statsCard.style.borderColor = 'var(--green)';
                        statsCard.style.background = 'var(--green-lt)';
                        statsCard.style.boxShadow = '0 3px 0 var(--green-dk)';
                    } else {
                        rankEl.style.color = 'var(--txt)';
                        statsCard.style.borderColor = 'var(--border)';
                        statsCard.style.background = 'var(--bg2)';
                        statsCard.style.boxShadow = '0 3px 0 var(--border)';
                    }
                } else {
                    rankEl.textContent = '--';
                }

                // Update other stats
                document.getElementById('statsTotalEarned').textContent = `‚Çπ${data.total_earned || 0}`;
                document.getElementById('statsBalance').textContent = `‚Çπ${data.current_balance || 0}`;
                document.getElementById('statsBestTime').textContent = data.best_time ? `${(data.best_time / 1000).toFixed(1)}s` : '--';
                document.getElementById('statsRoundsPlayed').textContent = data.rounds_played || 0;
                document.getElementById('statsRoundsWon').textContent = data.rounds_won || 0;
                document.getElementById('statsWinRate').textContent = `${data.win_rate || 0}%`;

                // Show encouragement messages
                showEncouragementMessage(data);
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        function showEncouragementMessage(data) {
            const msgEl = document.getElementById('encouragementMessage');
            const textEl = document.getElementById('encouragementText');
            let message = '';

            // Check conditions for encouragement messages
            if (data.current_balance >= 45 && data.current_balance < 50) {
                message = `Almost there! ‚Çπ${50 - data.current_balance} more to withdraw!`;
            } else if (data.win_rate < 50 && data.rounds_played > 0) {
                message = 'üí° Tip: Read questions carefully and think before answering!';
            } else if (data.rank && data.rank > 50) {
                message = 'üöÄ Keep playing to climb the leaderboard!';
            }

            if (message) {
                textEl.textContent = message;
                msgEl.style.display = 'block';
            } else {
                msgEl.style.display = 'none';
            }
        }

        function checkWithdrawReady() {
            const upiInput = document.getElementById('withdrawUpiInput');
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (upiInput && withdrawBtn) {
                withdrawBtn.disabled = !upiInput.value.trim() || !upiInput.value.includes('@');
            }
        }

        document.getElementById('withdrawUpiInput')?.addEventListener('input', checkWithdrawReady);

        async function submitWithdrawal() {
            const upiId = document.getElementById('withdrawUpiInput').value.trim();
            if (!upiId || !upiId.includes('@')) {
                alert('Please enter a valid UPI ID');
                return;
            }

            const withdrawBtn = document.getElementById('withdrawBtn');
            withdrawBtn.disabled = true;
            withdrawBtn.textContent = 'Processing...';

            try {
                const res = await fetch(`${API}/api/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        user_name: userName,
                        upi_id: upiId
                    })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    // Hide withdraw form, show success message
                    document.getElementById('withdrawSection').style.display = 'none';
                    document.getElementById('withdrawSuccessMessage').style.display = 'block';

                    // Update balance
                    document.getElementById('walletBalance').textContent = '0';
                    document.getElementById('walletCurrentBalance').textContent = '0';

                    // Reload wallet after 3 seconds
                    setTimeout(() => {
                        loadWallet();
                    }, 3000);
                } else {
                    alert(data.detail || 'Withdrawal failed. Please try again.');
                    withdrawBtn.disabled = false;
                    withdrawBtn.textContent = `Withdraw ‚Çπ${document.getElementById('withdrawAmount').textContent}`;
                }
            } catch (e) {
                console.error('Withdrawal error:', e);
                alert('Withdrawal failed. Please try again.');
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = `Withdraw ‚Çπ${document.getElementById('withdrawAmount').textContent}`;
            }
        }

        async function checkChallengeNotifications() {
            try {
                const res = await fetch(`${API}/api/challenge/my?user_id=${userId}`);
                if (!res.ok) return;
                const data = await res.json();
                if (!data.notifications || data.notifications.length === 0) return;

                // Check localStorage for already-seen notifications
                const seenKey = 'seen_challenge_notifs';
                let seen = [];
                try { seen = JSON.parse(localStorage.getItem(seenKey) || '[]'); } catch(e) { seen = []; }

                for (const notif of data.notifications) {
                    if (seen.includes(notif.challenge_code)) continue;

                    // Mark as seen
                    seen.push(notif.challenge_code);
                    localStorage.setItem(seenKey, JSON.stringify(seen));

                    const timeStr = (notif.challenger_time_ms / 1000).toFixed(1);
                    if (notif.status === 'lost') {
                        // Friend tried but couldn't beat challenger - challenger can reshare
                        const reshareText = '\uD83C\uDFC6 ' + notif.friend_name + ' couldn\'t beat my ' + timeStr + 's! Can YOU? \u2694\uFE0F\n\n\u23F0 Rounds daily: 7:00, 7:30, 8:00, 8:30 PM IST\n\uD83D\uDC49 ' + notif.share_url;
                        const tgUrl = 'https://t.me/share/url?url=' + encodeURIComponent(notif.share_url) + '&text=' + encodeURIComponent(reshareText);
                        showChallengeNotification(
                            notif.friend_name + ' tried your challenge but couldn\'t beat your time!',
                            'Share it again:',
                            notif.share_url,
                            reshareText,
                            tgUrl
                        );
                        break; // Show one at a time
                    } else if (notif.status === 'won') {
                        const friendTimeStr = notif.friend_time_ms ? (notif.friend_time_ms / 1000).toFixed(1) : '?';
                        showChallengeNotification(
                            notif.friend_name + ' beat your ' + timeStr + 's challenge with ' + friendTimeStr + 's!',
                            'They\'ve created a new challenge from their victory.',
                            null, null, null
                        );
                        break;
                    }
                }
            } catch (e) {
                console.error('Failed to check challenge notifications:', e);
            }
        }

        function showChallengeNotification(title, subtitle, shareUrl, shareText, tgUrl) {
            const notifDiv = document.createElement('div');
            notifDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:200;padding:16px;background:linear-gradient(135deg, var(--gold-lt), #fff8e1);border-bottom:3px solid var(--gold);box-shadow:0 4px 12px rgba(0,0,0,0.15)';
            let btnsHTML = '';
            if (shareUrl && tgUrl) {
                btnsHTML = `
                    <div style="display:flex;gap:8px;margin-top:12px">
                        <button class="duo-btn blue" style="flex:1;padding:10px;font-size:13px" onclick="window.open('${tgUrl}')">Share via Telegram</button>
                        <button class="duo-btn" style="flex:1;padding:10px;font-size:13px" onclick="copyChallengeLink('${shareUrl}', this)">Copy Link</button>
                    </div>
                `;
            }
            notifDiv.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div style="flex:1">
                        <div style="font-size:15px;font-weight:900;color:var(--txt);margin-bottom:4px">\u2694\uFE0F ${title}</div>
                        <div style="font-size:13px;font-weight:600;color:var(--txt2)">${subtitle}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px">\u2715</button>
                </div>
                ${btnsHTML}
            `;
            document.body.prepend(notifDiv);
            setTimeout(() => { if (notifDiv.parentElement) notifDiv.remove(); }, 30000);
        }

        // ‚îÄ‚îÄ‚îÄ CHALLENGE STATS / LEADERBOARD / HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function switchChallengeTab(tab) {
            document.getElementById('chalStatsTabBtn').classList.remove('active');
            document.getElementById('chalLbTabBtn').classList.remove('active');
            document.getElementById('chalHistTabBtn').classList.remove('active');
            document.getElementById('chalStatsTab').classList.remove('active');
            document.getElementById('chalLbTab').classList.remove('active');
            document.getElementById('chalHistTab').classList.remove('active');

            if (tab === 'stats') {
                document.getElementById('chalStatsTabBtn').classList.add('active');
                document.getElementById('chalStatsTab').classList.add('active');
                loadChallengeStats();
            } else if (tab === 'leaderboard') {
                document.getElementById('chalLbTabBtn').classList.add('active');
                document.getElementById('chalLbTab').classList.add('active');
                loadChallengeLeaderboard();
            } else if (tab === 'history') {
                document.getElementById('chalHistTabBtn').classList.add('active');
                document.getElementById('chalHistTab').classList.add('active');
                loadChallengeHistory();
            }
        }

        async function loadChallengeStats() {
            try {
                const res = await fetch(`${API}/api/challenge/stats?user_id=${userId}`);
                if (!res.ok) return;
                const d = await res.json();

                document.getElementById('chalBattlesWon').textContent = d.battles_won || 0;
                document.getElementById('chalBattlesLost').textContent = d.battles_lost || 0;
                document.getElementById('chalDefended').textContent = d.challenges_defended || 0;
                document.getElementById('chalLostDef').textContent = d.challenges_lost || 0;
                document.getElementById('chalWinStreak').textContent = d.win_streak || 0;
                document.getElementById('chalBestTime').textContent = d.best_time_ms ? (d.best_time_ms / 1000).toFixed(1) + 's' : '--';
                document.getElementById('chalScore').textContent = d.score || 0;
                document.getElementById('chalRank').textContent = d.rank ? '(Rank #' + d.rank + ')' : '';

                // Color the stats card based on score
                const card = document.getElementById('challengeStatsCard');
                if (d.score >= 20) {
                    card.style.borderColor = 'var(--gold)';
                    card.style.background = 'var(--gold-lt)';
                    card.style.boxShadow = '0 3px 0 var(--gold-dk)';
                } else if (d.score >= 10) {
                    card.style.borderColor = 'var(--green)';
                    card.style.background = 'var(--green-lt)';
                    card.style.boxShadow = '0 3px 0 var(--green-dk)';
                } else {
                    card.style.borderColor = 'var(--border)';
                    card.style.background = 'var(--bg2)';
                    card.style.boxShadow = '0 3px 0 var(--border)';
                }
            } catch (e) {
                console.error('Failed to load challenge stats:', e);
            }
        }

        async function loadChallengeLeaderboard() {
            try {
                const res = await fetch(`${API}/api/challenge/leaderboard`);
                if (!res.ok) return;
                const data = await res.json();
                const c = document.getElementById('challengeLeaderboard');

                if (!data.leaderboard || data.leaderboard.length === 0) {
                    c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No challenge battles yet! Be the first.</p>';
                    return;
                }

                let h = '<div style="text-align:center;margin-bottom:16px;font-size:20px;font-weight:900">\u2694\uFE0F CHALLENGE LEADERBOARD</div>';

                data.leaderboard.forEach((e, i) => {
                    const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : '';
                    const medal = i === 0 ? '\uD83E\uDD47' : i === 1 ? '\uD83E\uDD48' : i === 2 ? '\uD83E\uDD49' : '';
                    const isCurrentUser = e.user_id === userId;
                    const userCls = isCurrentUser ? 'user-row' : '';
                    const userBadge = isCurrentUser ? '<span class="user-badge">YOU</span>' : '';

                    h += `<div class="lb-row ${cls} ${userCls}">
                        ${medal ? '<span class="medal-icon">' + medal + '</span>' : '<div class="lb-rank">' + e.rank + '</div>'}
                        <div class="lb-name">${e.user_name || 'Anonymous'}${userBadge}</div>
                        <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
                            <div style="text-align:center">
                                <div style="font-size:10px;color:var(--txt3);font-weight:700">\u2694\uFE0F</div>
                                <div style="font-weight:800;font-size:13px;color:var(--green-dk)">${e.battles_won}</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:10px;color:var(--txt3);font-weight:700">\uD83D\uDEE1\uFE0F</div>
                                <div style="font-weight:800;font-size:13px;color:var(--blue-dk)">${e.challenges_defended}</div>
                            </div>
                            <div style="font-weight:900;font-size:16px;color:var(--gold-dk)">${e.score}</div>
                        </div>
                    </div>`;
                });

                c.innerHTML = h;
            } catch (e) {
                console.error('Failed to load challenge leaderboard:', e);
            }
        }

        async function loadChallengeHistory() {
            try {
                const res = await fetch(`${API}/api/challenge/history?user_id=${userId}`);
                if (!res.ok) return;
                const data = await res.json();
                const c = document.getElementById('challengeHistory');

                if (!data.history || data.history.length === 0) {
                    c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No battles yet! Challenge a friend after getting 4/4.</p>';
                    return;
                }

                let h = '';
                data.history.forEach(e => {
                    let resultColor, resultText, resultIcon;
                    if (e.result === 'won') {
                        resultColor = 'var(--green)'; resultText = 'WON'; resultIcon = '\u2705';
                    } else if (e.result === 'lost') {
                        resultColor = 'var(--red)'; resultText = 'LOST'; resultIcon = '\u274C';
                    } else if (e.result === 'pending') {
                        resultColor = 'var(--txt3)'; resultText = 'PENDING'; resultIcon = '\u23F3';
                    } else {
                        resultColor = 'var(--txt3)'; resultText = 'EXPIRED'; resultIcon = '\u23F0';
                    }

                    const userTimeStr = e.user_time_ms ? (e.user_time_ms / 1000).toFixed(1) + 's' : '--';
                    const oppTimeStr = e.opponent_time_ms ? (e.opponent_time_ms / 1000).toFixed(1) + 's' : '--';
                    const roleLabel = e.user_role === 'challenger' ? 'Challenger' : 'Friend';
                    const dateStr = e.created_at ? new Date(e.created_at + 'Z').toLocaleDateString('en-IN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';

                    let actionBtn = '';
                    if (e.result === 'pending' && e.user_role === 'friend') {
                        actionBtn = '<div style="margin-top:8px"><button class="duo-btn" style="padding:8px 14px;font-size:12px" onclick="switchTab(\'quiz\')">Play now!</button></div>';
                    } else if (e.result === 'pending' && e.user_role === 'challenger') {
                        actionBtn = '<div style="font-size:12px;color:var(--txt3);font-weight:600;margin-top:4px">Waiting for ' + e.opponent_name + '...</div>';
                    }

                    h += `<div class="lb-row" style="flex-direction:column;align-items:stretch;gap:6px;margin-bottom:8px">
                        <div style="display:flex;align-items:center;justify-content:space-between">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:18px">${resultIcon}</span>
                                <div>
                                    <div style="font-size:14px;font-weight:800;color:var(--txt)">vs ${e.opponent_name}</div>
                                    <div style="font-size:11px;color:var(--txt3);font-weight:600">${roleLabel} \u2022 ${dateStr}</div>
                                </div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:12px;font-weight:900;color:${resultColor};text-transform:uppercase">${resultText}</div>
                                <div style="font-size:12px;font-weight:700;color:var(--txt2)">${userTimeStr} vs ${oppTimeStr}</div>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>`;
                });

                c.innerHTML = h;
            } catch (e) {
                console.error('Failed to load challenge history:', e);
            }
        }

        loadCurrentRound();
        loadWallet();
        checkChallengeNotifications();
    </script>
</body>

</html>