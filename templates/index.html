<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>MedicNEET Quiz</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #fff;
            --bg2: #f7f7f7;
            --border: #e5e5e5;
            --green: #58cc02;
            --green-dk: #46a302;
            --green-lt: #d7ffb8;
            --red: #ff4b4b;
            --red-lt: #ffdada;
            --gold: #ffc800;
            --gold-dk: #ce9c09;
            --gold-lt: #fff4cc;
            --blue: #1cb0f6;
            --blue-dk: #1899d6;
            --blue-lt: #ddf4ff;
            --orange: #ff9600;
            --orange-lt: #fff0d4;
            --purple: #ce82ff;
            --txt: #3c3c3c;
            --txt2: #777;
            --txt3: #afafaf
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            color: var(--txt);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased
        }

        .header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--green)
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .logo-icon {
            font-size: 24px
        }

        .logo-text {
            font-weight: 900;
            font-size: 18px;
            color: #fff
        }

        .prize-badge {
            background: var(--gold);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 14px;
            color: var(--txt);
            box-shadow: 0 3px 0 var(--gold-dk);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .prize-badge:active {
            transform: translateY(3px);
            box-shadow: none
        }

        .timer-section {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg2);
            border-bottom: 2px solid var(--border)
        }

        .timer-label {
            font-size: 10px;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 800
        }

        .timer-value {
            font-size: 30px;
            font-weight: 900;
            font-variant-numeric: tabular-nums
        }

        .timer-value.danger {
            color: var(--red)
        }

        .stats-row {
            display: flex;
            gap: 8px
        }

        .stat-pill {
            padding: 6px 12px;
            border-radius: 12px;
            text-align: center
        }

        .stat-pill.blue {
            background: var(--blue-lt)
        }

        .stat-pill.orange {
            background: var(--orange-lt)
        }

        .stat-num {
            font-size: 15px;
            font-weight: 800
        }

        .stat-pill.blue .stat-num {
            color: var(--blue-dk)
        }

        .stat-pill.orange .stat-num {
            color: var(--orange)
        }

        .stat-lbl {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--txt3)
        }

        .screen {
            display: none;
            padding: 16px
        }

        .screen.active {
            display: block
        }

        .question-chapter {
            display: inline-block;
            background: var(--green-lt);
            color: var(--green-dk);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 14px
        }

        .question-text {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.65;
            margin-bottom: 20px
        }

        .question-block {
            background: var(--bg2);
            border: 2px solid var(--border);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 3px 0 var(--border)
        }

        .question-number {
            display: inline-block;
            background: var(--green);
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 10px
        }

        .question-block.answered {
            border-color: var(--green);
            background: var(--green-lt)
        }

        .question-block.correct {
            border-color: var(--green);
            background: var(--green-lt);
            box-shadow: 0 3px 0 var(--green-dk)
        }

        .question-block.incorrect {
            border-color: var(--red);
            background: var(--red-lt);
            box-shadow: 0 3px 0 var(--red)
        }

        .stopwatch {
            text-align: center;
            margin-bottom: 16px
        }

        .stopwatch-value {
            font-size: 56px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            letter-spacing: -3px;
            line-height: 1
        }

        .stopwatch-label {
            font-size: 10px;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
            margin-top: 4px
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .option-btn {
            width: 100%;
            padding: 16px 18px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--txt);
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            text-align: left;
            box-shadow: 0 3px 0 var(--border);
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .option-btn:active {
            transform: translateY(3px);
            box-shadow: none
        }

        .opt-letter {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: var(--bg2);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            flex-shrink: 0
        }

        .option-btn.correct {
            border-color: var(--green);
            background: var(--green-lt);
            box-shadow: 0 3px 0 var(--green-dk)
        }

        .option-btn.correct .opt-letter {
            background: var(--green);
            border-color: var(--green-dk);
            color: #fff
        }

        .option-btn.wrong {
            border-color: var(--red);
            background: var(--red-lt);
            box-shadow: 0 3px 0 var(--red)
        }

        .option-btn.wrong .opt-letter {
            background: var(--red);
            border-color: var(--red);
            color: #fff
        }

        .result-card {
            text-align: center;
            padding: 28px 20px;
            border-radius: 24px;
            border: 2px solid var(--border);
            margin-bottom: 16px;
            box-shadow: 0 4px 0 var(--border)
        }

        .result-card.win {
            background: var(--gold-lt);
            border-color: var(--gold);
            box-shadow: 0 4px 0 var(--gold-dk)
        }

        .result-card.correct {
            background: var(--green-lt);
            border-color: var(--green);
            box-shadow: 0 4px 0 var(--green-dk)
        }

        .result-card.wrong {
            background: var(--red-lt);
            border-color: var(--red);
            box-shadow: 0 4px 0 var(--red)
        }

        .result-icon {
            font-size: 56px;
            margin-bottom: 8px
        }

        .result-title {
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 4px
        }

        .result-title.win-text {
            color: var(--txt)
        }

        .result-title.correct-text {
            color: var(--green-dk)
        }

        .result-title.wrong-text {
            color: var(--red)
        }

        .result-sub {
            font-size: 14px;
            color: var(--txt2);
            font-weight: 600;
            margin-bottom: 16px
        }

        .result-time {
            font-size: 48px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            line-height: 1
        }

        .result-time-label {
            font-size: 12px;
            color: var(--txt3);
            font-weight: 700;
            margin-top: 4px
        }

        .share-challenge-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 800;
            font-family: inherit;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #388E3C;
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .share-challenge-btn:active {
            transform: translateY(4px);
            box-shadow: none
        }

        .explanation-card {
            background: var(--blue-lt);
            border: 2px solid var(--blue);
            border-radius: 18px;
            padding: 16px 18px;
            margin-bottom: 16px;
            box-shadow: 0 3px 0 var(--blue-dk)
        }

        .explanation-header {
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--blue-dk);
            margin-bottom: 8px
        }

        .explanation-text {
            font-size: 14px;
            line-height: 1.6;
            font-weight: 600
        }

        .winner-form {
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 0 var(--gold-dk)
        }

        .winner-form h3 {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 16px;
            text-align: center
        }

        .form-group {
            margin-bottom: 14px
        }

        .form-group label {
            display: block;
            font-size: 11px;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
            margin-bottom: 6px
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg2);
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 15px;
            font-family: inherit;
            font-weight: 600;
            outline: none
        }

        .form-input:focus {
            border-color: var(--gold)
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            cursor: pointer
        }

        .upload-area:hover {
            border-color: var(--gold)
        }

        .upload-area.has-file {
            border-color: var(--green);
            border-style: solid;
            background: var(--green-lt)
        }

        .upload-icon {
            font-size: 28px;
            margin-bottom: 6px
        }

        .upload-text {
            font-size: 13px;
            color: var(--txt3);
            font-weight: 700
        }

        .duo-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 800;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--green-dk);
            color: #fff;
            background: var(--green);
            -webkit-tap-highlight-color: transparent;
            transition: transform .05s
        }

        .duo-btn:active {
            transform: translateY(4px);
            box-shadow: none
        }

        .duo-btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .duo-btn.gold {
            background: var(--gold);
            box-shadow: 0 4px 0 var(--gold-dk);
            color: var(--txt)
        }

        .duo-btn.blue {
            background: var(--blue);
            box-shadow: 0 4px 0 var(--blue-dk);
            color: #fff
        }

        .duo-btn.purple {
            background: var(--purple);
            box-shadow: 0 4px 0 #a855d6;
            color: #fff
        }

        .cta-banner {
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            box-shadow: 0 4px 0 var(--border)
        }

        .cta-banner h3 {
            font-size: 17px;
            font-weight: 900;
            margin-bottom: 6px
        }

        .cta-banner p {
            color: var(--txt2);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px
        }

        /* Launching Soon CTA */
        .notify-cta {
            border: 2px solid var(--purple);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            box-shadow: 0 4px 0 #a855d6;
            background: linear-gradient(135deg, #f3e0ff 0%, #fff 100%)
        }

        .notify-cta h3 {
            font-size: 18px;
            font-weight: 900;
            color: var(--txt);
            margin-bottom: 4px
        }

        .notify-cta .badge {
            display: inline-block;
            background: var(--purple);
            color: #fff;
            padding: 3px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 10px
        }

        .notify-cta p {
            color: var(--txt2);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px
        }

        .notify-row {
            display: flex;
            gap: 8px
        }

        .notify-input {
            flex: 1;
            padding: 14px 14px;
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 600;
            outline: none
        }

        .notify-input:focus {
            border-color: var(--purple)
        }

        .notify-submit {
            padding: 14px 20px;
            border: none;
            border-radius: 14px;
            background: var(--purple);
            color: #fff;
            font-size: 14px;
            font-weight: 800;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 3px 0 #a855d6;
            white-space: nowrap
        }

        .notify-submit:active {
            transform: translateY(3px);
            box-shadow: none
        }

        .notify-submit:disabled {
            opacity: .5
        }

        .notify-success {
            color: var(--green-dk);
            font-weight: 700;
            font-size: 13px;
            margin-top: 8px
        }

        .notify-count {
            color: var(--txt3);
            font-size: 12px;
            font-weight: 700;
            margin-top: 6px
        }

        .sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 2px
        }

        .sub-tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 800;
            font-family: inherit;
            color: var(--txt3);
            cursor: pointer;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            transition: color .2s
        }

        .sub-tab-btn.active {
            color: var(--green)
        }

        .sub-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--green);
            border-radius: 2px
        }

        .sub-tab-content {
            display: none
        }

        .sub-tab-content.active {
            display: block
        }

        .lb-row.user-row {
            border-width: 3px;
            background: var(--purple) !important;
            border-color: #a855d6 !important;
            box-shadow: 0 3px 0 #a855d6
        }

        .lb-row .user-badge {
            display: inline-block;
            background: var(--purple);
            color: #fff;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            margin-left: 6px
        }

        .medal-icon {
            font-size: 20px;
            margin-right: 4px
        }

        .lb-section {
            margin-top: 16px
        }

        .lb-title {
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--txt3);
            margin-bottom: 10px
        }

        .lb-row {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-radius: 16px;
            margin-bottom: 8px;
            border: 2px solid var(--border);
            box-shadow: 0 3px 0 var(--border)
        }

        .lb-row.first {
            border-color: var(--gold);
            background: var(--gold-lt);
            box-shadow: 0 3px 0 var(--gold-dk)
        }

        .lb-row.second {
            border-color: var(--green);
            background: var(--green-lt);
            box-shadow: 0 3px 0 var(--green-dk)
        }

        .lb-row.third {
            border-color: var(--blue);
            background: var(--blue-lt);
            box-shadow: 0 3px 0 var(--blue-dk)
        }

        .lb-rank {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 14px;
            margin-right: 12px;
            background: var(--border);
            color: var(--txt2)
        }

        .lb-row.first .lb-rank {
            background: var(--gold);
            color: #fff
        }

        .lb-row.second .lb-rank {
            background: var(--green);
            color: #fff
        }

        .lb-row.third .lb-rank {
            background: var(--blue);
            color: #fff
        }

        .lb-name {
            flex: 1;
            font-weight: 700;
            font-size: 14px
        }

        .lb-time {
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            font-size: 14px
        }

        .lb-wins {
            font-weight: 800;
            color: var(--gold-dk);
            font-size: 14px
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: var(--bg);
            border-top: 2px solid var(--border);
            padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            z-index: 100
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 2px
        }

        .nav-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--txt3);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .nav-item.active .nav-label {
            color: var(--green)
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: var(--green);
            border-radius: 2px
        }

        .nav-item.active {
            position: relative
        }

        .loading {
            text-align: center;
            padding: 60px 20px
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--green);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 16px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .page-content {
            padding-bottom: 80px
        }

        .next-round-card {
            text-align: center;
            padding: 40px 20px;
            border-radius: 24px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 0 var(--border)
        }

        .next-round-card .countdown {
            font-size: 44px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            color: var(--blue);
            margin: 12px 0
        }

        /* ========== RESPONSIVE OPTIMIZATIONS ========== */

        /* Small screens (up to 480px) */
        @media screen and (max-width: 480px) {
            .header {
                padding: 12px 14px;
            }

            .logo-icon {
                font-size: 22px;
            }

            .logo-text {
                font-size: 16px;
            }

            .prize-badge {
                padding: 5px 12px;
                font-size: 13px;
                border-radius: 16px;
            }

            .timer-section {
                padding: 8px 14px;
            }

            .timer-value {
                font-size: 26px;
            }

            .timer-label {
                font-size: 9px;
            }

            .stat-pill {
                padding: 5px 10px;
                border-radius: 10px;
            }

            .stat-num {
                font-size: 14px;
            }

            .stat-lbl {
                font-size: 8px;
            }

            .screen {
                padding: 14px;
            }

            .stopwatch-value {
                font-size: 48px;
                letter-spacing: -2px;
            }

            .question-text {
                font-size: 15px;
                line-height: 1.5;
                margin-bottom: 16px;
            }

            .option-btn {
                padding: 14px 16px;
                border-radius: 14px;
                font-size: 14px;
            }

            .opt-letter {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }

            .result-card {
                padding: 24px 16px;
                border-radius: 20px;
                margin-bottom: 14px;
            }

            .result-icon {
                font-size: 48px;
            }

            .result-title {
                font-size: 22px;
            }

            .result-sub {
                font-size: 13px;
                margin-bottom: 14px;
            }

            .result-time {
                font-size: 42px;
            }

            .explanation-card {
                padding: 14px 16px;
                border-radius: 16px;
            }

            .explanation-text {
                font-size: 13px;
                line-height: 1.5;
            }

            .winner-form {
                padding: 16px;
                border-radius: 18px;
            }

            .winner-form h3 {
                font-size: 18px;
                margin-bottom: 14px;
            }

            .form-input {
                padding: 12px 14px;
                font-size: 14px;
            }

            .upload-area {
                padding: 16px;
            }

            .duo-btn {
                padding: 14px;
                font-size: 15px;
            }

            .cta-banner {
                padding: 16px;
                border-radius: 18px;
            }

            .cta-banner h3 {
                font-size: 16px;
            }

            .cta-banner p {
                font-size: 12px;
            }

            .notify-cta {
                padding: 16px;
                border-radius: 18px;
            }

            .notify-cta h3 {
                font-size: 16px;
            }

            .notify-cta p {
                font-size: 12px;
            }

            .notify-row {
                flex-direction: column;
                gap: 10px;
            }

            .notify-input,
            .notify-submit {
                padding: 12px 14px;
                font-size: 13px;
            }

            .lb-row {
                padding: 10px 12px;
                border-radius: 14px;
            }

            .lb-name {
                font-size: 13px;
            }

            .lb-time,
            .lb-wins {
                font-size: 13px;
            }

            h2 {
                font-size: 20px !important;
            }

            .next-round-card {
                padding: 32px 16px;
                border-radius: 20px;
            }

            .next-round-card .countdown {
                font-size: 38px;
            }

            .nav-icon {
                font-size: 20px;
            }

            .nav-label {
                font-size: 9px;
            }

            .nav-item.active::after {
                width: 36px;
                height: 3px;
            }

            .page-content {
                padding-bottom: 70px;
            }
        }

        /* Extra small screens (up to 360px) */
        @media screen and (max-width: 360px) {
            .header {
                padding: 10px 12px;
            }

            .logo-icon {
                font-size: 20px;
            }

            .logo-text {
                font-size: 15px;
            }

            .prize-badge {
                padding: 4px 10px;
                font-size: 12px;
                border-radius: 14px;
            }

            .timer-value {
                font-size: 24px;
            }

            .screen {
                padding: 12px;
            }

            .stopwatch-value {
                font-size: 42px;
            }

            .question-text {
                font-size: 14px;
                margin-bottom: 14px;
            }

            .option-btn {
                padding: 12px 14px;
                gap: 10px;
            }

            .opt-letter {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .result-card {
                padding: 20px 14px;
            }

            .result-icon {
                font-size: 42px;
            }

            .result-title {
                font-size: 20px;
            }

            .result-time {
                font-size: 36px;
            }

            .winner-form h3 {
                font-size: 17px;
            }

            .stats-row {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .stat-pill {
                min-width: 70px;
            }

            .nav-item {
                padding: 6px;
            }

            .nav-icon {
                font-size: 18px;
            }

            .nav-label {
                font-size: 8px;
            }

            .page-content {
                padding-bottom: 65px;
            }
        }

        /* Very small screens (up to 320px) */
        @media screen and (max-width: 320px) {
            .timer-value {
                font-size: 22px;
            }

            .stopwatch-value {
                font-size: 38px;
            }

            .question-chapter {
                font-size: 10px;
                padding: 3px 12px;
            }

            .option-btn {
                padding: 10px 12px;
                font-size: 13px;
            }

            .opt-letter {
                width: 28px;
                height: 28px;
            }

            .stat-pill {
                padding: 4px 8px;
                min-width: 65px;
            }

            .stat-num {
                font-size: 13px;
            }

            .result-time {
                font-size: 32px;
            }

            .notify-cta .badge {
                font-size: 10px;
                padding: 2px 10px;
            }

            .lb-name {
                font-size: 12px;
            }
        }

        /* Tablet and landscape orientation adjustments */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .option-btn {
                padding: 15px 18px;
            }

            .result-card {
                padding: 30px 24px;
            }

            .winner-form {
                padding: 24px;
            }
        }

        /* Prevent text overflow on very small screens */
        .option-btn div:last-child {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* Ensure safe area for notched phones */
        @supports (padding: max(0px)) {
            .bottom-nav {
                padding: 6px 0 max(6px, env(safe-area-inset-bottom));
            }

            .page-content {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Improve tap targets for mobile */
        button,
        .nav-item,
        .upload-area {
            min-height: 44px;
        }

        /* Prevent zoom on input focus for iOS */
        @media screen and (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Smooth transitions for layout changes */
        .screen,
        .header,
        .timer-section,
        .bottom-nav {
            transition: all 0.2s ease;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">ü¶â</div>
            <div class="logo-text">MedicNEET</div>
        </div>
        <div class="prize-badge" id="walletBadge" onclick="switchTab('wallet')">üí∞ Wallet: ‚Çπ<span id="walletBalance">0</span></div>
    </div>
    <div class="timer-section" id="timerSection">
        <div>
            <div class="timer-label" id="timerLabel">Prize ends in</div>
            <div class="timer-value" id="roundTimer">--:--</div>
        </div>
        <div class="stats-row">
            <div class="stat-pill blue">
                <div class="stat-num" id="statFastest">--</div>
                <div class="stat-lbl">Fastest</div>
            </div>
            <div class="stat-pill orange">
                <div class="stat-num" id="statAttempts">0</div>
                <div class="stat-lbl">Playing</div>
            </div>
        </div>
    </div>
    <div id="practiceModeBanner"
        style="display:none;background:var(--orange-lt);padding:8px 16px;text-align:center;border-bottom:2px solid var(--orange)">
        <span style="font-weight:800;color:var(--orange);font-size:13px">‚è∞ PRACTICE MODE ‚Äî Prize window ended. Next
            question in <span id="nextQuestionTime">--:--</span></span>
    </div>
    <div class="page-content">
        <div class="screen active" id="loadingScreen">
            <div class="loading">
                <div class="spinner"></div>
                <p style="color:var(--txt3);font-weight:700">Loading question...</p>
            </div>
        </div>

        <div class="screen" id="quizScreen">
            <div class="stopwatch">
                <div class="stopwatch-value" id="stopwatch">0.00</div>
                <div class="stopwatch-label">Your time (seconds)</div>
            </div>
            <div id="questionsContainer"></div>
            <button class="duo-btn" id="submitBtn" onclick="submitAllAnswers()" disabled style="margin-top:20px">Submit All Answers</button>
        </div>

        <div class="screen" id="resultScreen">
            <div class="result-card" id="resultCard">
                <div class="result-icon" id="resultIcon"></div>
                <div class="result-title" id="resultTitle"></div>
                <div class="result-sub" id="resultSub"></div>
                <div class="result-time" id="resultTime"></div>
                <div class="result-time-label">seconds</div>
            </div>
            <button class="share-challenge-btn" id="shareChallengeBtn" onclick="shareChallenge()">
                üîó Share & Challenge Friends
            </button>
            <div class="explanation-card" id="explanationCard" style="display:none">
                <div class="explanation-header">üìñ Explanation</div>
                <div class="explanation-text" id="explanationText"></div>
            </div>
            <div class="winner-form" id="winnerForm" style="display:none">
                <h3>üèÜ Claim Your ‚Çπ50 Prize!</h3>
                <p style="color:var(--txt2);font-size:13px;margin-bottom:14px;text-align:center">Submit your details.
                    Payment within 24 hours.</p>
                <div class="form-group"><label>Your UPI ID</label><input type="text" class="form-input" id="upiInput"
                        placeholder="name@upi or 9876543210@paytm"></div>
                <div class="form-group"><label>Your Photo (for channel announcement)</label>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">Tap to upload photo</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/jpeg,image/png" style="display:none"
                        onchange="handlePhotoUpload(this)">
                </div>
                <button class="duo-btn gold" id="claimBtn" onclick="submitWinnerDetails()" disabled>Submit Details
                    üéâ</button>
            </div>
            <div id="appCTA"></div>
            <div class="lb-section" id="roundLeaderboard"></div>
        </div>

        <div class="screen" id="leaderboardScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üèÜ TOP</h2>

            <div class="sub-tabs">
                <button class="sub-tab-btn" id="thisRoundTabBtn" onclick="switchLeaderboardTab('thisRound')">This Round</button>
                <button class="sub-tab-btn active" id="allTimeTabBtn" onclick="switchLeaderboardTab('allTime')">All Time</button>
            </div>

            <div class="sub-tab-content" id="thisRoundTab">
                <div id="thisRoundLeaderboard">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div class="sub-tab-content active" id="allTimeTab">
                <div id="allTimeLeaderboard">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div id="lbCTA"></div>
        </div>

        <div class="screen" id="historyScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üìú Recent Winners</h2>
            <div id="historyList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div class="screen" id="waitingScreen">
            <div class="next-round-card">
                <div style="font-size:56px">‚è≥</div>
                <div style="font-size:20px;font-weight:900;margin-top:12px">Next Question Coming</div>
                <div class="countdown" id="nextRoundCountdown">--:--:--</div>
                <div style="color:var(--txt3);font-size:14px;font-weight:700">Stay tuned ‚Äî ‚Çπ50 up for grabs!</div>
            </div>
            <div id="waitCTA"></div>
        </div>

        <div class="screen" id="walletScreen">
            <h2 style="font-size:22px;font-weight:900;margin-bottom:16px">üí∞ Your Wallet</h2>

            <div class="result-card" style="background:var(--gold-lt);border-color:var(--gold);box-shadow:0 4px 0 var(--gold-dk);margin-bottom:20px">
                <div style="font-size:14px;color:var(--txt2);font-weight:700;margin-bottom:4px">Current Balance</div>
                <div style="font-size:48px;font-weight:900;color:var(--txt);line-height:1">‚Çπ<span id="walletCurrentBalance">0</span></div>
                <div style="font-size:12px;color:var(--txt3);font-weight:700;margin-top:12px">Total Earned: ‚Çπ<span id="walletTotalEarned">0</span></div>
            </div>

            <div id="statsSection" style="margin-bottom:20px">
                <h3 style="font-size:18px;font-weight:900;margin-bottom:12px">üìä YOUR STATS</h3>

                <div id="statsCard" style="background:var(--bg2);border:2px solid var(--border);border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 3px 0 var(--border)">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üèÖ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Rank</div>
                                <div id="statsRank" style="font-size:18px;font-weight:900;color:var(--txt)">--</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üí∞</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Total Earned</div>
                                <div id="statsTotalEarned" style="font-size:18px;font-weight:900;color:var(--txt)">‚Çπ0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üí≥</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Balance</div>
                                <div id="statsBalance" style="font-size:18px;font-weight:900;color:var(--txt)">‚Çπ0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">‚ö°</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Best Time</div>
                                <div id="statsBestTime" style="font-size:18px;font-weight:900;color:var(--txt)">--</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üéÆ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Rounds Played</div>
                                <div id="statsRoundsPlayed" style="font-size:18px;font-weight:900;color:var(--txt)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="font-size:24px">üèÜ</div>
                            <div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Rounds Won</div>
                                <div id="statsRoundsWon" style="font-size:18px;font-weight:900;color:var(--txt)">0</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;grid-column:1/-1">
                            <div style="font-size:24px">üìà</div>
                            <div style="flex:1">
                                <div style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase">Win Rate</div>
                                <div id="statsWinRate" style="font-size:18px;font-weight:900;color:var(--txt)">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="encouragementMessage" style="display:none;background:var(--blue-lt);border:2px solid var(--blue);border-radius:16px;padding:14px;text-align:center;box-shadow:0 3px 0 var(--blue-dk)">
                    <div style="font-size:14px;font-weight:700;color:var(--blue-dk)" id="encouragementText"></div>
                </div>
            </div>

            <div id="withdrawSection" style="display:none;margin-bottom:20px">
                <div class="winner-form">
                    <h3>üí∏ Withdraw Money</h3>
                    <p style="color:var(--txt2);font-size:13px;margin-bottom:14px;text-align:center">Minimum withdrawal: ‚Çπ50</p>
                    <div class="form-group">
                        <label>Your UPI ID</label>
                        <input type="text" class="form-input" id="withdrawUpiInput" placeholder="name@upi or 9876543210@paytm">
                    </div>
                    <button class="duo-btn gold" id="withdrawBtn" onclick="submitWithdrawal()" disabled>Withdraw ‚Çπ<span id="withdrawAmount">0</span></button>
                </div>
            </div>

            <div id="withdrawMinMessage" style="display:none;text-align:center;padding:20px;background:var(--orange-lt);border:2px solid var(--orange);border-radius:18px;margin-bottom:20px">
                <div style="font-size:14px;font-weight:700;color:var(--orange)">Earn ‚Çπ<span id="needMoreAmount">50</span> more to withdraw</div>
            </div>

            <div id="withdrawSuccessMessage" style="display:none;text-align:center;padding:20px;background:var(--green-lt);border:2px solid var(--green);border-radius:18px;margin-bottom:20px">
                <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
                <h3 style="margin-bottom:8px;font-size:20px">Withdrawal Requested!</h3>
                <p style="color:var(--txt2);font-size:14px;font-weight:600">You'll receive payment within 24 hours</p>
            </div>

            <div class="lb-section">
                <div class="lb-title">üíµ Transaction History</div>
                <div id="transactionsList">
                    <p style="color:var(--txt3);text-align:center;padding:20px;font-weight:700">No transactions yet</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('quiz')">
            <div class="nav-icon">‚ö°</div>
            <div class="nav-label">Quiz</div>
        </div>
        <div class="nav-item" onclick="switchTab('wallet')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-label">Wallet</div>
        </div>
        <div class="nav-item" onclick="switchTab('leaderboard')">
            <div class="nav-icon">üèÜ</div>
            <div class="nav-label">Top</div>
        </div>
        <div class="nav-item" onclick="switchTab('history')">
            <div class="nav-icon">üìú</div>
            <div class="nav-label">History</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp; if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#58cc02'); tg.setBackgroundColor('#ffffff') }
        const user = tg?.initDataUnsafe?.user || { id: 'test_' + Date.now(), first_name: 'Test' };
        const userId = String(user.id), userName = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'Anonymous', initData = tg?.initData || '';
        const APP_STATUS = '{{ app_status }}', PLAYSTORE_LINK = '{{ playstore_link }}';
        let currentRound = null, stopwatchInterval = null, stopwatchStart = null, roundTimerInterval = null, hasAttempted = false, selectedPhoto = null;
        let userAnswers = [null, null, null, null];  // Track answers for 4 questions
        let submitCountdownInterval = null, submitTimeRemaining = 60;  // 60 second countdown timer
        const API = '';

        // ‚îÄ‚îÄ‚îÄ CTA BUILDER (Launching Soon vs Live) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function buildCTA(containerId) {
            const el = document.getElementById(containerId); if (!el) return;
            if (APP_STATUS === 'live' && PLAYSTORE_LINK) {
                el.innerHTML = `<div class="cta-banner"><h3>üî• Practice 2000+ Questions!</h3><p>NEET 2025 ‚Äî Statement, Sequence & Match types.</p><button class="duo-btn" onclick="window.open('${PLAYSTORE_LINK}','_blank')">Download MedicNEET ‚¨áÔ∏è</button></div>`;
            } else {
                const uid = 'notify_' + containerId;
                el.innerHTML = `
        <div class="notify-cta">
            <div class="badge">üöÄ LAUNCHING SOON</div>
            <h3>MedicNEET App</h3>
            <p>2000+ NEET 2025 style questions ‚Äî Statement,<br>Sequence & Match types. Get notified at launch!</p>
            <div class="notify-row">
                <input type="email" class="notify-input" id="${uid}" placeholder="your@email.com">
                <button class="notify-submit" onclick="submitNotifyEmail('${uid}',this)">Notify Me</button>
            </div>
            <div id="${uid}_msg"></div>
        </div>`;
            }
        }

        async function submitNotifyEmail(inputId, btn) {
            const inp = document.getElementById(inputId); const email = inp.value.trim();
            if (!email || !email.includes('@') || !email.includes('.')) {
                document.getElementById(inputId + '_msg').innerHTML = '<div style="color:var(--red);font-weight:700;font-size:13px;margin-top:8px">Please enter a valid email</div>'; return;
            }
            btn.disabled = true; btn.textContent = '...';
            try {
                const res = await fetch(`${API}/api/notify-email`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, user_id: userId, user_name: userName }) });
                const data = await res.json();
                if (data.success) {
                    document.getElementById(inputId + '_msg').innerHTML = `<div class="notify-success">‚úÖ You're in! We'll email you at launch.</div><div class="notify-count">${data.total_signups} people waiting</div>`;
                    inp.style.display = 'none'; btn.style.display = 'none';
                } else { btn.disabled = false; btn.textContent = 'Notify Me'; }
            } catch (e) { btn.disabled = false; btn.textContent = 'Notify Me' }
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id)?.classList.add('active') }
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');
            if (tab === 'quiz') { if (currentRound && !hasAttempted) showScreen('quizScreen'); else if (hasAttempted) showScreen('resultScreen'); else showScreen('waitingScreen') }
            else if (tab === 'wallet') { showScreen('walletScreen'); loadWallet() }
            else if (tab === 'leaderboard') { showScreen('leaderboardScreen'); loadAllTimeLeaderboard() }
            else if (tab === 'history') { showScreen('historyScreen'); loadHistory() }
        }

        async function loadCurrentRound() {
            try {
                const res = await fetch(`${API}/api/current-round`);
                if (!res.ok) { showScreen('waitingScreen'); buildCTA('waitCTA'); return }
                const data = await res.json();
                currentRound = data;
                hasAttempted = false;
                userAnswers = [null, null, null, null];

                document.getElementById('statAttempts').textContent = data.stats.attempts;
                document.getElementById('statFastest').textContent = data.stats.fastest_time_ms ? (data.stats.fastest_time_ms / 1000).toFixed(1) + 's' : '--';
                startPrizeTimer(data.prize_ends_at, data.ends_at);

                // Build 4 questions UI
                const container = document.getElementById('questionsContainer');
                container.innerHTML = '';

                data.questions.forEach((q, idx) => {
                    const qBlock = document.createElement('div');
                    qBlock.className = 'question-block';
                    qBlock.id = `question-${idx}`;
                    qBlock.innerHTML = `
                        <div class="question-number">Question ${idx + 1}</div>
                        <div class="question-chapter">${q.chapter || 'NEET Biology'}</div>
                        <div class="question-text">${q.text}</div>
                        <div class="options">
                            <button class="option-btn" data-question="${idx}" data-answer="A" onclick="selectQuestionAnswer(${idx}, 'A', this)">
                                <div class="opt-letter">A</div>
                                <div>${q.option_a}</div>
                            </button>
                            <button class="option-btn" data-question="${idx}" data-answer="B" onclick="selectQuestionAnswer(${idx}, 'B', this)">
                                <div class="opt-letter">B</div>
                                <div>${q.option_b}</div>
                            </button>
                            <button class="option-btn" data-question="${idx}" data-answer="C" onclick="selectQuestionAnswer(${idx}, 'C', this)">
                                <div class="opt-letter">C</div>
                                <div>${q.option_c}</div>
                            </button>
                            <button class="option-btn" data-question="${idx}" data-answer="D" onclick="selectQuestionAnswer(${idx}, 'D', this)">
                                <div class="opt-letter">D</div>
                                <div>${q.option_d}</div>
                            </button>
                        </div>
                    `;
                    container.appendChild(qBlock);
                });

                document.getElementById('submitBtn').disabled = true;
                showScreen('quizScreen');
                startStopwatch();
                startSubmitCountdown();
            } catch (e) {
                console.error(e);
                showScreen('waitingScreen');
                buildCTA('waitCTA');
            }
        }

        function startStopwatch() {
            stopwatchStart = performance.now(); clearInterval(stopwatchInterval);
            stopwatchInterval = setInterval(() => { document.getElementById('stopwatch').textContent = ((performance.now() - stopwatchStart) / 1000).toFixed(2) }, 50)
        }
        function stopStopwatch() { clearInterval(stopwatchInterval); return Math.round(performance.now() - stopwatchStart) }

        function startSubmitCountdown() {
            submitTimeRemaining = 60;
            clearInterval(submitCountdownInterval);
            const submitBtn = document.getElementById('submitBtn');

            // Initial state - disabled with countdown
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            updateSubmitButtonText();

            submitCountdownInterval = setInterval(() => {
                submitTimeRemaining--;

                if (submitTimeRemaining > 0) {
                    updateSubmitButtonText();
                } else {
                    // Countdown complete
                    clearInterval(submitCountdownInterval);
                    submitBtn.textContent = 'Submit All Answers';
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';

                    // Enable button only if all questions are answered
                    const allAnswered = userAnswers.every(a => a !== null);
                    submitBtn.disabled = !allAnswered;
                }
            }, 1000);
        }

        function updateSubmitButtonText() {
            const submitBtn = document.getElementById('submitBtn');
            const seconds = submitTimeRemaining;
            const display = `0:${String(seconds).padStart(2, '0')}`;
            submitBtn.textContent = `Submit in ${display}`;
        }

        let prizeWindowActive = true;
        function startPrizeTimer(prizeEndsAt, roundEndsAt) {
            clearInterval(roundTimerInterval);
            const prizeEnd = prizeEndsAt ? new Date(prizeEndsAt + 'Z').getTime() : 0;
            const roundEnd = new Date(roundEndsAt + 'Z').getTime();

            roundTimerInterval = setInterval(() => {
                const now = Date.now();
                const prizeRemaining = prizeEnd - now;
                const roundRemaining = roundEnd - now;

                if (roundRemaining <= 0) {
                    clearInterval(roundTimerInterval);
                    document.getElementById('roundTimer').textContent = '00:00';
                    setTimeout(() => loadCurrentRound(), 3000);
                    return;
                }

                if (prizeRemaining > 0) {
                    // Prize window still active
                    prizeWindowActive = true;
                    document.getElementById('timerSection').style.display = 'flex';
                    document.getElementById('practiceModeBanner').style.display = 'none';
                    document.getElementById('timerLabel').textContent = 'üí∞ PRIZE ENDS IN';
                    const m = Math.floor(prizeRemaining / 60000);
                    const s = Math.floor((prizeRemaining % 60000) / 1000);
                    document.getElementById('roundTimer').textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    if (prizeRemaining < 30000) document.getElementById('roundTimer').classList.add('danger');
                    else document.getElementById('roundTimer').classList.remove('danger');
                } else {
                    // Practice mode
                    prizeWindowActive = false;
                    document.getElementById('timerSection').style.display = 'none';
                    document.getElementById('practiceModeBanner').style.display = 'block';
                    const h = Math.floor(roundRemaining / 3600000);
                    const m = Math.floor((roundRemaining % 3600000) / 60000);
                    const s = Math.floor((roundRemaining % 60000) / 1000);
                    document.getElementById('nextQuestionTime').textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                }
            }, 1000);
        }

        function selectQuestionAnswer(questionIdx, answer, btn) {
            if (hasAttempted) return;

            // Remove selection from other options in this question
            const questionBlock = document.getElementById(`question-${questionIdx}`);
            questionBlock.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.background = 'var(--bg)';
                b.style.borderColor = 'var(--border)';
            });

            // Mark this option as selected
            btn.classList.add('selected');
            btn.style.background = 'var(--blue-lt)';
            btn.style.borderColor = 'var(--blue)';

            // Store the answer
            userAnswers[questionIdx] = answer;

            // Mark question block as answered
            questionBlock.classList.add('answered');

            // Enable submit button if all 4 questions are answered AND countdown is complete
            const allAnswered = userAnswers.every(a => a !== null);
            const submitBtn = document.getElementById('submitBtn');

            // Only enable if countdown is complete (submitTimeRemaining <= 0)
            if (submitTimeRemaining <= 0 && allAnswered) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        async function submitAllAnswers() {
            if (hasAttempted) return;
            hasAttempted = true;
            const tms = stopStopwatch();

            document.getElementById('submitBtn').disabled = true;
            document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');

            try {
                const res = await fetch(`${API}/api/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        round_id: currentRound.round_id,
                        user_id: userId,
                        user_name: userName,
                        answers: userAnswers,
                        time_ms: tms,
                        init_data: initData
                    })
                });

                if (res.status === 400) {
                    const err = await res.json();
                    if (err.detail === 'Already attempted') {
                        showAlreadyAttempted();
                        return;
                    }
                }

                const data = await res.json();

                // Show correct/wrong for each question
                data.results.forEach((isCorrect, idx) => {
                    const questionBlock = document.getElementById(`question-${idx}`);
                    questionBlock.classList.add(isCorrect ? 'correct' : 'incorrect');

                    const buttons = questionBlock.querySelectorAll('.option-btn');
                    buttons.forEach(btn => {
                        const btnAnswer = btn.dataset.answer;
                        if (btnAnswer === data.correct_answers[idx]) {
                            btn.classList.add('correct');
                        } else if (btnAnswer === userAnswers[idx] && !isCorrect) {
                            btn.classList.add('wrong');
                        }
                    });
                });

                setTimeout(() => showResult(data, tms), 1200);
            } catch (e) {
                console.error(e);
                hasAttempted = false;
                document.getElementById('submitBtn').disabled = false;
                document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'auto');
            }
        }

        function showResult(data, tms) {
            const ts = (tms / 1000).toFixed(2);
            const card = document.getElementById('resultCard');
            const inPrizeWindow = data.prize_window_active !== false;
            const correctCount = data.results.filter(r => r).length;
            const allCorrect = data.all_correct;

            // Store for sharing
            lastScore = correctCount;
            lastTime = ts;

            if (data.is_current_winner && inPrizeWindow) {
                card.className = 'result-card win';
                document.getElementById('resultIcon').textContent = 'üèÜ';
                document.getElementById('resultTitle').textContent = "YOU'RE WINNING!";
                document.getElementById('resultTitle').className = 'result-title win-text';
                document.getElementById('resultSub').textContent = 'Solved 4/4 correctly ‚Äî fastest time! Claim your ‚Çπ50!';
                document.getElementById('winnerForm').style.display = 'block';
                document.getElementById('resultTime').style.color = 'var(--green)';
            }
            else if (allCorrect && inPrizeWindow) {
                card.className = 'result-card correct';
                document.getElementById('resultIcon').textContent = '‚úÖ';
                document.getElementById('resultTitle').textContent = 'All Correct!';
                document.getElementById('resultTitle').className = 'result-title correct-text';
                document.getElementById('resultSub').textContent = 'Solved 4/4 ‚Äî Someone was faster. Try next round!';
                document.getElementById('winnerForm').style.display = 'none';
                document.getElementById('resultTime').style.color = 'var(--green-dk)';
            }
            else if (allCorrect && !inPrizeWindow) {
                card.className = 'result-card correct';
                document.getElementById('resultIcon').textContent = '‚úÖ';
                document.getElementById('resultTitle').textContent = 'All Correct!';
                document.getElementById('resultTitle').className = 'result-title correct-text';
                document.getElementById('resultSub').textContent = 'Practice mode ‚Äî Solved 4/4! Nice revision!';
                document.getElementById('winnerForm').style.display = 'none';
                document.getElementById('resultTime').style.color = 'var(--green-dk)';
            }
            else {
                card.className = 'result-card wrong';
                document.getElementById('resultIcon').textContent = '‚ùå';
                document.getElementById('resultTitle').textContent = `${correctCount}/4 Correct`;
                document.getElementById('resultTitle').className = 'result-title wrong-text';
                document.getElementById('resultSub').textContent = inPrizeWindow ? 'Need all 4 correct to win!' : 'Practice mode ‚Äî Need all 4 correct to win!';
                document.getElementById('winnerForm').style.display = 'none';
                document.getElementById('resultTime').style.color = 'var(--txt)';
            }

            document.getElementById('resultTime').textContent = ts;

            // Show explanations for incorrect answers
            const expCard = document.getElementById('explanationCard');
            let hasExplanations = false;
            let expHTML = '<div class="explanation-header">üìñ Explanations</div>';

            data.explanations.forEach((exp, idx) => {
                if (!data.results[idx] && exp?.trim()) {
                    hasExplanations = true;
                    expHTML += `<div style="margin-bottom:12px"><strong>Q${idx + 1}:</strong> Correct answer was ${data.correct_answers[idx]}. ${exp}</div>`;
                }
            });

            if (hasExplanations) {
                expCard.innerHTML = expHTML;
                expCard.style.display = 'block';
            } else {
                expCard.style.display = 'none';
            }

            buildCTA('appCTA');
            buildRoundLeaderboard(data.leaderboard);

            // Reload wallet if user won
            if (iw || allCorrect) {
                loadWallet();
            }

            if (tg?.HapticFeedback) {
                if (data.is_current_winner) tg.HapticFeedback.notificationOccurred('success');
                else if (allCorrect) tg.HapticFeedback.notificationOccurred('warning');
                else tg.HapticFeedback.notificationOccurred('error');
            }

            showScreen('resultScreen');
        }

        function showAlreadyAttempted() {
            const card = document.getElementById('resultCard'); card.className = 'result-card';
            document.getElementById('resultIcon').textContent = '‚è∞'; document.getElementById('resultTitle').textContent = 'Already Played';
            document.getElementById('resultTitle').className = 'result-title'; document.getElementById('resultSub').textContent = 'Next question coming soon!';
            document.getElementById('resultTime').textContent = '--'; document.getElementById('winnerForm').style.display = 'none';
            document.getElementById('explanationCard').style.display = 'none'; document.getElementById('roundLeaderboard').innerHTML = ''; buildCTA('appCTA'); showScreen('resultScreen')
        }

        function buildRoundLeaderboard(lb) {
            const c = document.getElementById('roundLeaderboard'); if (!lb?.length) { c.innerHTML = ''; return }
            let h = '<div class="lb-title">‚ö° This Round ‚Äî Fastest Correct</div>';
            lb.forEach((e, i) => {
                const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : ''; const me = e.user_name === userName;
                h += `<div class="lb-row ${cls}" ${me ? 'style="border-width:3px"' : ''}><div class="lb-rank">${i + 1}</div><div class="lb-name">${e.user_name}${me ? ' (You)' : ''}</div><div class="lb-time">${(e.time_ms / 1000).toFixed(2)}s</div></div>`
            }); c.innerHTML = h
        }

        function switchLeaderboardTab(tab) {
            // Update tab buttons
            document.getElementById('thisRoundTabBtn').classList.remove('active');
            document.getElementById('allTimeTabBtn').classList.remove('active');

            // Update tab content
            document.getElementById('thisRoundTab').classList.remove('active');
            document.getElementById('allTimeTab').classList.remove('active');

            if (tab === 'thisRound') {
                document.getElementById('thisRoundTabBtn').classList.add('active');
                document.getElementById('thisRoundTab').classList.add('active');
                loadThisRoundLeaderboard();
            } else {
                document.getElementById('allTimeTabBtn').classList.add('active');
                document.getElementById('allTimeTab').classList.add('active');
                loadAllTimeLeaderboard();
            }
        }

        async function loadThisRoundLeaderboard() {
            try {
                const res = await fetch(`${API}/api/leaderboard`);
                const data = await res.json();
                const c = document.getElementById('thisRoundLeaderboard');

                if (!data.leaderboard?.length) {
                    c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No winners yet!</p>';
                    return;
                }

                let h = '';
                data.leaderboard.forEach((e, i) => {
                    const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : '';
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    h += `<div class="lb-row ${cls}">
                        <div class="lb-rank">${medal || i + 1}</div>
                        <div class="lb-name">${e.user_name}</div>
                        <div class="lb-wins">${e.wins} üèÜ</div>
                        <div class="lb-time" style="margin-left:10px">‚Çπ${e.total_won}</div>
                    </div>`;
                });
                c.innerHTML = h;
            } catch (e) {
                console.error(e);
            }
        }

        async function loadAllTimeLeaderboard() {
            try {
                const res = await fetch(`${API}/api/leaderboard/alltime?user_id=${userId}`);
                const data = await res.json();
                const c = document.getElementById('allTimeLeaderboard');

                if (!data.leaderboard?.length) {
                    c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No winners yet!</p>';
                    buildCTA('lbCTA');
                    return;
                }

                let h = '<div style="text-align:center;margin-bottom:16px;font-size:28px;font-weight:900">üèÜ ALL-TIME LEADERBOARD</div>';

                data.leaderboard.forEach((e, i) => {
                    const cls = i === 0 ? 'first' : i === 1 ? 'second' : i === 2 ? 'third' : '';
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                    const isCurrentUser = e.user_id === userId;
                    const userCls = isCurrentUser ? 'user-row' : '';
                    const userBadge = isCurrentUser ? '<span class="user-badge">YOU</span>' : '';
                    const bestTime = e.best_time ? (e.best_time / 1000).toFixed(1) + 's' : '--';

                    h += `<div class="lb-row ${cls} ${userCls}">
                        ${medal ? `<span class="medal-icon">${medal}</span>` : `<div class="lb-rank">${e.rank}</div>`}
                        <div class="lb-name">${e.user_name}${userBadge}</div>
                        <div class="lb-time" style="margin-left:auto;margin-right:10px">‚Çπ${e.total_earned}</div>
                        <div class="lb-time" style="color:var(--txt3)">${bestTime}</div>
                    </div>`;
                });

                c.innerHTML = h;
                buildCTA('lbCTA');
            } catch (e) {
                console.error(e);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${API}/api/history`); const data = await res.json(); const c = document.getElementById('historyList');
                if (!data.history?.length) { c.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:40px;font-weight:700">No rounds yet.</p>'; return }
                let h = ''; data.history.forEach(e => { h += `<div class="lb-row" style="flex-direction:column;align-items:flex-start;gap:4px"><div style="font-size:12px;color:var(--txt3);font-weight:700">${e.chapter || 'Biology'}</div><div style="font-size:14px;font-weight:700">${e.question.substring(0, 80)}...</div><div style="display:flex;justify-content:space-between;width:100%"><span style="color:var(--gold-dk);font-weight:800">üèÜ ${e.winner_name || 'No winner'}</span><span style="color:var(--green);font-weight:800">${e.winner_time_ms ? (e.winner_time_ms / 1000).toFixed(1) + 's' : '--'}</span></div></div>` }); c.innerHTML = h
            } catch (e) { }
        }

        function handlePhotoUpload(input) {
            const f = input.files[0]; if (!f) return; selectedPhoto = f; const a = document.getElementById('uploadArea');
            a.classList.add('has-file'); a.innerHTML = `<div class="upload-icon">‚úÖ</div><div class="upload-text">${f.name}</div>`; checkClaimReady()
        }
        function checkClaimReady() { document.getElementById('claimBtn').disabled = !(document.getElementById('upiInput').value.trim() && selectedPhoto) }
        document.getElementById('upiInput')?.addEventListener('input', checkClaimReady);

        async function submitWinnerDetails() {
            const btn = document.getElementById('claimBtn'); btn.disabled = true; btn.textContent = 'Uploading...';
            const fd = new FormData(); fd.append('round_id', currentRound.round_id); fd.append('user_id', userId);
            fd.append('upi_id', document.getElementById('upiInput').value.trim()); fd.append('photo', selectedPhoto);
            try {
                const res = await fetch(`${API}/api/winner-photo`, { method: 'POST', body: fd }); const data = await res.json();
                if (data.success) { document.getElementById('winnerForm').innerHTML = `<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:12px">‚úÖ</div><h3 style="margin-bottom:8px;font-size:20px">Details Submitted!</h3><p style="color:var(--txt2);font-size:14px;font-weight:600">‚Çπ50 will be sent to your UPI within 24 hours.</p><p style="color:var(--green-dk);font-size:13px;font-weight:700;margin-top:8px">You'll be announced on the channel now! üéâ</p></div>` }
                else { btn.textContent = 'Submit Details üéâ'; btn.disabled = false }
            }
            catch (e) { btn.textContent = 'Submit Details üéâ'; btn.disabled = false }
        }

        let lastScore = 0;
        let lastTime = '0.00';

        async function shareChallenge() {
            const shareText = `üß† I scored ${lastScore}/4 in ${lastTime}s on MedicNEET Quiz!

Can you beat my time? üí™

Play now üëâ https://t.me/Winners_neetbot/Medicneet

#NEET2026 #MedicNEET`;

            // Try using navigator.share() for mobile
            if (navigator.share) {
                try {
                    await navigator.share({
                        text: shareText
                    });
                } catch (err) {
                    // User cancelled or error occurred, fall back to clipboard
                    if (err.name !== 'AbortError') {
                        copyToClipboard(shareText);
                    }
                }
            } else {
                // Fall back to clipboard copy on desktop
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied! Share with friends');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Copied! Share with friends');
            } catch (err) {
                alert('Could not copy. Please share manually.');
            }
            document.body.removeChild(textarea);
        }

        async function loadWallet() {
            try {
                const res = await fetch(`${API}/api/wallet?user_id=${userId}`);
                const data = await res.json();

                const balance = data.balance || 0;
                const totalEarned = data.total_earned || 0;

                // Update header badge
                document.getElementById('walletBalance').textContent = balance;

                // Update wallet screen
                document.getElementById('walletCurrentBalance').textContent = balance;
                document.getElementById('walletTotalEarned').textContent = totalEarned;

                // Show/hide withdraw section based on balance
                if (balance >= 50) {
                    document.getElementById('withdrawSection').style.display = 'block';
                    document.getElementById('withdrawMinMessage').style.display = 'none';
                    document.getElementById('withdrawAmount').textContent = balance;
                    document.getElementById('withdrawUpiInput').value = data.upi_id || '';
                    checkWithdrawReady();
                } else {
                    document.getElementById('withdrawSection').style.display = 'none';
                    document.getElementById('withdrawMinMessage').style.display = 'block';
                    document.getElementById('needMoreAmount').textContent = 50 - balance;
                }

                // Display transactions
                const txList = document.getElementById('transactionsList');
                if (data.transactions && data.transactions.length > 0) {
                    let txHTML = '';
                    data.transactions.forEach(tx => {
                        const date = new Date(tx.created_at).toLocaleDateString();
                        txHTML += `<div class="lb-row" style="background:var(--green-lt);border-color:var(--green)">
                            <div style="flex:1">
                                <div style="font-weight:700;font-size:14px">Round #${tx.round_id || '?'}</div>
                                <div style="font-size:11px;color:var(--txt3);font-weight:700">${date}</div>
                            </div>
                            <div style="font-weight:800;font-size:16px;color:var(--green)">+‚Çπ${tx.amount}</div>
                        </div>`;
                    });
                    txList.innerHTML = txHTML;
                } else {
                    txList.innerHTML = '<p style="color:var(--txt3);text-align:center;padding:20px;font-weight:700">No transactions yet</p>';
                }

                // Load stats
                loadStats();
            } catch (e) {
                console.error('Failed to load wallet:', e);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API}/api/stats?user_id=${userId}`);
                const data = await res.json();

                // Update rank with color based on position
                const rankEl = document.getElementById('statsRank');
                const statsCard = document.getElementById('statsCard');

                if (data.rank && data.total_players > 0) {
                    rankEl.textContent = `#${data.rank} of ${data.total_players}`;

                    // Color coding based on rank
                    if (data.rank <= 10) {
                        rankEl.style.color = 'var(--gold)';
                        statsCard.style.borderColor = 'var(--gold)';
                        statsCard.style.background = 'var(--gold-lt)';
                        statsCard.style.boxShadow = '0 3px 0 var(--gold-dk)';
                    } else if (data.rank <= 50) {
                        rankEl.style.color = 'var(--green)';
                        statsCard.style.borderColor = 'var(--green)';
                        statsCard.style.background = 'var(--green-lt)';
                        statsCard.style.boxShadow = '0 3px 0 var(--green-dk)';
                    } else {
                        rankEl.style.color = 'var(--txt)';
                        statsCard.style.borderColor = 'var(--border)';
                        statsCard.style.background = 'var(--bg2)';
                        statsCard.style.boxShadow = '0 3px 0 var(--border)';
                    }
                } else {
                    rankEl.textContent = '--';
                }

                // Update other stats
                document.getElementById('statsTotalEarned').textContent = `‚Çπ${data.total_earned || 0}`;
                document.getElementById('statsBalance').textContent = `‚Çπ${data.current_balance || 0}`;
                document.getElementById('statsBestTime').textContent = data.best_time ? `${(data.best_time / 1000).toFixed(1)}s` : '--';
                document.getElementById('statsRoundsPlayed').textContent = data.rounds_played || 0;
                document.getElementById('statsRoundsWon').textContent = data.rounds_won || 0;
                document.getElementById('statsWinRate').textContent = `${data.win_rate || 0}%`;

                // Show encouragement messages
                showEncouragementMessage(data);
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        function showEncouragementMessage(data) {
            const msgEl = document.getElementById('encouragementMessage');
            const textEl = document.getElementById('encouragementText');
            let message = '';

            // Check conditions for encouragement messages
            if (data.current_balance >= 45 && data.current_balance < 50) {
                message = `Almost there! ‚Çπ${50 - data.current_balance} more to withdraw!`;
            } else if (data.win_rate < 50 && data.rounds_played > 0) {
                message = 'üí° Tip: Read questions carefully and think before answering!';
            } else if (data.rank && data.rank > 50) {
                message = 'üöÄ Keep playing to climb the leaderboard!';
            }

            if (message) {
                textEl.textContent = message;
                msgEl.style.display = 'block';
            } else {
                msgEl.style.display = 'none';
            }
        }

        function checkWithdrawReady() {
            const upiInput = document.getElementById('withdrawUpiInput');
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (upiInput && withdrawBtn) {
                withdrawBtn.disabled = !upiInput.value.trim() || !upiInput.value.includes('@');
            }
        }

        document.getElementById('withdrawUpiInput')?.addEventListener('input', checkWithdrawReady);

        async function submitWithdrawal() {
            const upiId = document.getElementById('withdrawUpiInput').value.trim();
            if (!upiId || !upiId.includes('@')) {
                alert('Please enter a valid UPI ID');
                return;
            }

            const withdrawBtn = document.getElementById('withdrawBtn');
            withdrawBtn.disabled = true;
            withdrawBtn.textContent = 'Processing...';

            try {
                const res = await fetch(`${API}/api/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        user_name: userName,
                        upi_id: upiId
                    })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    // Hide withdraw form, show success message
                    document.getElementById('withdrawSection').style.display = 'none';
                    document.getElementById('withdrawSuccessMessage').style.display = 'block';

                    // Update balance
                    document.getElementById('walletBalance').textContent = '0';
                    document.getElementById('walletCurrentBalance').textContent = '0';

                    // Reload wallet after 3 seconds
                    setTimeout(() => {
                        loadWallet();
                    }, 3000);
                } else {
                    alert(data.detail || 'Withdrawal failed. Please try again.');
                    withdrawBtn.disabled = false;
                    withdrawBtn.textContent = `Withdraw ‚Çπ${document.getElementById('withdrawAmount').textContent}`;
                }
            } catch (e) {
                console.error('Withdrawal error:', e);
                alert('Withdrawal failed. Please try again.');
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = `Withdraw ‚Çπ${document.getElementById('withdrawAmount').textContent}`;
            }
        }

        loadCurrentRound();
        loadWallet();
    </script>
</body>

</html>